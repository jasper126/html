<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAY SIGHT Woning Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Primaire kleuren (Aangepaste Baysight huisstijl) */
            --primary-blue: #042943;
            --primary-orange: #d4915f;
            --primary-turquoise: #00A5CF;
            
            /* Secundaire kleuren */
            --secondary-light: #F0F4F8;
            --secondary-medium: #D9E2EC;
            --secondary-dark: #627D98;
            
            /* Functionele kleuren */
            --success: #31C48D;
            --warning: #F0B429;
            --error: #E12D39;
            
            /* Tekst kleuren */
            --text-primary: #102A43;
            --text-secondary: #486581;
            --text-light: #829AB1;
            
            /* Achtergrond kleuren */
            --bg-light: #FFFFFF;
            --bg-off-white: #F8FAFC;
            --bg-highlight: #EFF6FF;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-off-white);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .baysight-calculator-container {
            width: 100%;
            max-width: 1160px; /* Aangepaste breedte voor desktop */
            margin: 0 auto;
            background-color: var(--bg-light);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .calculator-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .calculator-header h2 {
            margin: 0;
            font-size: 2.5rem;
            font-family: 'DM Serif Display', serif;
            font-weight: 400;
            color: var(--primary-orange);
        }

        .calculator-tabs {
            display: flex;
            background-color: var(--secondary-light);
            border-bottom: 1px solid var(--secondary-medium);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1 1 auto;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab:hover {
            background-color: var(--bg-highlight);
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-orange);
            background-color: var(--bg-light);
        }
         .tab.disabled {
            color: var(--text-light);
            cursor: not-allowed;
            background-color: var(--secondary-light);
        }


        .calculator-section {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calculator-section.active {
            display: block;
        }

        .progress-indicator {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--secondary-medium);
            padding-bottom: 1rem;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            position: relative;
            color: var(--text-light);
            font-weight: 500;
        }

        .progress-step.active {
            color: var(--primary-blue);
            font-weight: 700;
        }

        .progress-step.completed {
            color: var(--primary-blue);
            font-weight: 500;
        }
        .progress-step.completed::before {
             content: '✔';
             color: var(--success);
             margin-right: 0.5rem;
        }


        .progress-step::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1rem;
            height: 1rem;
            background-color: var(--secondary-medium);
            border-radius: 50%;
            border: 2px solid var(--bg-off-white);
            transition: background-color 0.3s ease;
        }

        .progress-step.active::after {
            background-color: var(--primary-orange);
            transform: translateX(-50%) scale(1.2);
        }

        .progress-step.completed::after {
            background-color: var(--success);
        }

        .input-form {
            display: none;
        }

        .input-form.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            box-sizing: border-box;
            display: block;
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-light);
            border: 1px solid var(--secondary-medium);
            border-radius: 4px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-turquoise);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 165, 207, 0.25);
        }

        /* Custom styling for range inputs */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--secondary-medium);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        
        input[type="range"]:hover {
            opacity: 1;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary-orange);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--primary-orange);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }


        .range-value {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .range-value .current-value {
            font-weight: 700;
            color: var(--primary-blue);
            background-color: var(--bg-highlight);
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
        }
        
        .toggle-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--secondary-light);
            padding: 0.75rem;
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--secondary-dark);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-orange);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label-text {
            font-weight: 600;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .toggle-label-text.inactive {
            color: var(--text-light);
            font-weight: 500;
        }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background-color: #c07e4d;
            color: white;
            box-shadow: 0 4px 10px rgba(212, 145, 95, 0.4);
        }

        .btn-secondary {
            background-color: var(--secondary-medium);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            color: white;
        }

        .btn:disabled {
            background-color: var(--secondary-medium);
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn:disabled:hover {
             background-color: var(--secondary-medium);
             color: var(--text-primary);
        }

        .results-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--secondary-medium);
        }
        .results-tabs::-webkit-scrollbar {
            height: 5px;
        }
        .results-tabs::-webkit-scrollbar-thumb {
            background: var(--secondary-medium); 
            border-radius: 10px;
        }


        .result-tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* Align with border */
            white-space: nowrap;
        }

        .result-tab:hover {
            color: var(--primary-blue);
        }

        .result-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-orange);
        }

        .result-panel {
            display: none;
            animation: fadeIn 0.5s;
        }

        .result-panel.active {
            display: block;
        }

        .summary-header {
            margin-bottom: 1.5rem;
        }
        .summary-header h3 {
            color: var(--primary-blue);
        }

        .property-info {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background-color: var(--bg-light);
            border: 1px solid var(--secondary-light);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
        }

        .summary-card h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-blue);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-orange);
        }

        .summary-chart-container {
            height: 250px;
        }

        .panel-section {
            margin-bottom: 2.5rem;
        }

        .panel-section h4 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--secondary-light);
            padding-bottom: 0.5rem;
        }

        .chart-container {
            height: 350px;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--secondary-medium);
        }

        .data-table th {
            background-color: var(--secondary-light);
            font-weight: 600;
        }
        .data-table tbody tr:hover {
            background-color: var(--bg-highlight);
        }
        .data-table .total-row td {
            font-weight: 700;
            color: var(--primary-blue);
        }

        .considerations-list {
            background-color: var(--bg-highlight);
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 5px solid var(--primary-turquoise);
            margin-top: 2rem;
        }
        .considerations-list h4 {
            margin-top: 0;
            color: var(--primary-blue);
        }

        .considerations-list ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .considerations-list li {
            margin-bottom: 0.75rem;
        }

        .result-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--secondary-medium);
        }
        
        .country-comparison {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--bg-light);
            border: 1px solid var(--secondary-light);
            border-radius: 8px;
        }
        
        .country-comparison h4 {
             margin-top: 0;
             color: var(--primary-blue);
             margin-bottom: 1rem;
        }

        .country-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }

        .country-badge.montenegro { background-color: var(--primary-orange); }
        .country-badge.spanje { background-color: var(--warning); color: var(--text-primary); }
        .country-badge.portugal { background-color: var(--primary-turquoise); }
        .country-badge.italie { background-color: var(--success); }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip .tooltip-icon {
            font-style: normal;
            font-weight: 700;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--secondary-dark);
            color: white;
            font-size: 12px;
            margin-left: 8px;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--primary-blue);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--primary-blue) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }


        @media (max-width: 1159px) { /* Adjust breakpoint for smaller screens */
            .baysight-calculator-container {
                max-width: 100%;
            }
             .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body { padding: 0; }
            .baysight-calculator-container { border-radius: 0; }
            .calculator-section { padding: 1.5rem; }

            .progress-indicator {
                flex-direction: column;
                border-bottom: none;
                gap: 0.5rem;
                padding-bottom: 0;
            }

            .progress-step {
                text-align: left;
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--secondary-medium);
            }

            .progress-step::after {
                display: none;
            }
            
            .form-navigation {
                flex-direction: column-reverse;
                gap: 1rem;
            }

            .result-actions {
                 flex-direction: column;
                 align-items: stretch;
            }

            .btn {
                width: 100%;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>
    <div class="baysight-calculator-container">
        <div class="calculator-header">
            <h2>Woning Calculator</h2>
        </div>

        <div class="calculator-tabs">
            <div class="tab active" data-tab="input">Start & Invoer</div>
            <div class="tab disabled" data-tab="results">Resultaten</div>
        </div>
        
        <div class="calculator-section active" id="input-section">
            <div class="progress-indicator">
                <div class="progress-step active" data-step="1">1. Woning</div>
                <div class="progress-step" data-step="2">2. Financieel</div>
                <div class="progress-step" data-step="3">3. Gebruik</div>
                <div class="progress-step" data-step="4">4. Voorkeuren</div>
            </div>
            
            <div class="input-form active" id="step-0">
                <div class="panel-section">
                    <h4>Uitleg van de Calculator</h4>
                    <p>Deze calculator is ontworpen om u een gedetailleerd en realistisch inzicht te geven in het potentiële rendement van een vastgoedinvestering. Onze berekeningen zijn niet zomaar schattingen; ze zijn gebaseerd op een diepgaande analyse van de meest recente, openbare data.</p>
                    
                    <h5>Onze Databronnen</h5>
                    <p>Voor de nauwkeurigheid van deze tool vertrouwen we uitsluitend op gezaghebbende bronnen, waaronder:</p>
                    <ul>
                        <li><strong>Nationale Statistische Bureaus:</strong> Gegevens over vastgoedprijzen, transactievolumes en economische indicatoren zijn afkomstig van de officiële CBS-equivalenten van elk land, zoals MONSTAT (Montenegro), INE (Spanje), INE Portugal, en ISTAT (Italië).</li>
                        <li><strong>Belastingautoriteiten:</strong> Alle berekeningen van overdrachtsbelasting, jaarlijkse eigendomsbelasting en belasting op huurinkomsten zijn gebaseerd op de officiële, meest recente tarieven en wetgeving van de respectievelijke belastingdiensten.</li>
                        <li><strong>Onafhankelijke Marktanalyse:</strong> Voor parameters zoals gemiddelde huurrendementen en beheerkosten maken we gebruik van data van gerenommeerde, onafhankelijke vastgoedanalisten zoals de Global Property Guide, en analyses van financiële instellingen zoals PwC en BBVA Research.</li>
                    </ul>

                    <h5>Transparante Berekeningen</h5>
                    <p>De tool berekent dynamisch de kosten en opbrengsten voor uw specifieke situatie. Wanneer u een aankoopprijs invoert, wordt voor elk land een parallelle berekening gemaakt van de transactiekosten en het te verwachten netto huurrendement. Dit stelt u in staat om een eerlijke, data-gedreven vergelijking te maken.</p>
                    
                    <div class="considerations-list" style="border-left-color: var(--warning);">
                         <h4>Disclaimer</h4>
                         <p>Hoewel we streven naar maximale nauwkeurigheid, dient deze calculator als een indicatief hulpmiddel. De vastgoedmarkt is dynamisch en werkelijke resultaten kunnen afwijken. Deze berekening vormt geen financieel advies. Wij raden u ten zeerste aan om contact op te nemen voor een persoonlijk adviesgesprek om uw specifieke situatie te bespreken.</p>
                    </div>
                </div>
            </div>

            <div class="input-form" id="step-1">
                <h3>Woninggegevens in Montenegro</h3>
                
                <div class="form-group">
                    <label for="purchasePrice">Aankoopprijs (€)</label>
                    <input type="number" id="purchasePrice" class="form-control" placeholder="bv. 250000" value="250000" min="0">
                </div>

                 <div class="form-group">
                    <label for="furnishingCosts">Inrichtingskosten (€) (Optioneel)</label>
                    <input type="number" id="furnishingCosts" class="form-control" placeholder="bv. 20000" min="0">
                </div>
                
                <div class="form-group">
                    <label>Staat van de woning</label>
                    <div class="toggle-switch-container">
                        <span class="toggle-label-text" id="existing-label">Bestaande bouw</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="propertyCondition" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label-text active" id="new-label">Nieuwbouw</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="propertySize">Woonoppervlakte (m²)</label>
                    <input type="number" id="propertySize" class="form-control" min="20" placeholder="bv. 80" value="80">
                </div>

                 <div class="form-group">
                    <label for="region">Regio</label>
                    <select id="region" class="form-control">
                        <option value="Kotor">Baai van Kotor</option>
                        <option value="Budva">Budva Riviera</option>
                        <option value="Tivat">Tivat & Luštica</option>
                        <option value="Bar">Bar & Ulcinj</option>
                        <option value="Noord">Noord (Binnenland)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="propertyType">Type woning</label>
                    <select id="propertyType" class="form-control">
                        <option value="Appartement">Appartement</option>
                        <option value="Villa">Villa</option>
                        <option value="Townhouse">Townhouse</option>
                        <option value="Landhuis">Landhuis</option>
                    </select>
                </div>
            </div>

            <div class="input-form" id="step-2">
                <h3>Financiële gegevens</h3>
                
                <div class="form-group">
                    <label for="ownCapital">Beschikbaar eigen vermogen (€)</label>
                    <input type="number" id="ownCapital" class="form-control" placeholder="bv. 150000" value="150000" min="0">
                </div>
                
                <div class="form-group">
                     <label>Heeft u financiering nodig?</label>
                    <div class="toggle-switch-container">
                        <span class="toggle-label-text active" id="no-financing-label">Nee</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="needFinancing">
                            <span class="toggle-slider"></span>
                        </label>
                         <span class="toggle-label-text inactive" id="yes-financing-label">Ja</span>
                    </div>
                </div>
                
                <div class="financing-details" style="display: none;">
                    <div class="form-group">
                        <label for="financingInterestRate">Rentepercentage (%)</label>
                        <input type="number" id="financingInterestRate" class="form-control" min="0" max="20" step="0.1" value="5.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="financingTerm">Looptijd financiering (jaren)</label>
                        <input type="number" id="financingTerm" class="form-control" min="1" max="30" value="20">
                    </div>
                </div>
            </div>

            <div class="input-form" id="step-3">
                <h3>Gebruiksgegevens</h3>
                
                <div class="form-group">
                    <label for="usageType">Primair gebruiksdoel</label>
                    <select id="usageType" class="form-control">
                        <option value="Combinatie">Combinatie (Eigen gebruik & Verhuur)</option>
                        <option value="Vakantiewoning">Alleen eigen gebruik (Vakantiewoning)</option>
                        <option value="LangeTermijnVerhuur">Volledige Lange Termijn Verhuur</option>
                        <option value="KorteTermijnVerhuur">Volledige Korte Termijn Verhuur (Vakantie)</option>
                    </select>
                </div>
                
                <div class="rental-details">
                     <div class="form-group">
                        <label for="personalUsageWeeks">Aantal weken per jaar voor eigen gebruik</label>
                        <input type="range" id="personalUsageWeeks" class="form-range" min="0" max="52" value="4">
                        <div class="range-value">
                            <span>0 weken</span>
                            <span class="current-value" id="personalUsageWeeksValue">4</span>
                            <span>52 weken</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-form" id="step-4">
                <h3>Voorkeuren</h3>
                 <div class="form-group">
                    <label for="managementPreference">Voorkeur voor beheer (indien verhuur)</label>
                    <select id="managementPreference" class="form-control">
                        <option value="Volledig uitbesteden">Volledig uitbesteden (Aanbevolen)</option>
                        <option value="Gedeeltelijk uitbesteden">Gedeeltelijk uitbesteden</option>
                        <option value="Zelf actief beheren">Zelf actief beheren</option>
                    </select>
                </div>
            </div>
            
            <div class="form-navigation">
                <button class="btn btn-secondary btn-prev" disabled>Vorige</button>
                <button class="btn btn-primary btn-next">Volgende</button>
                <button class="btn btn-primary btn-calculate" style="display: none;">Bereken</button>
            </div>
        </div>
        
        <div class="calculator-section" id="results-section">
            <div class="results-tabs">
                <div class="result-tab active" data-result="summary">Samenvatting</div>
                <div class="result-tab" data-result="financial">Investering & Kosten</div>
                <div class="result-tab" data-result="rental">Verhuurpotentieel</div>
                <div class="result-tab" data-result="roi">Rendement Analyse</div>
                <div class="result-tab" data-result="comparison">Landenvergelijking</div>
            </div>
            
            <div class="result-panel active" id="summary-panel">
                 <div class="summary-header">
                     <h3>Uw Investeringsprofiel</h3>
                     <div class="property-info">
                         <span id="summary-property-type">Appartement</span> in 
                         <span id="summary-region">Baai van Kotor</span>,
                         <span>Montenegro</span>
                     </div>
                 </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>Totale Investering</h4>
                        <div class="summary-value" id="summary-total-investment">€0</div>
                         <p>Bestaat uit aankoopprijs en alle bijkomende kosten.</p>
                    </div>
                    
                    <div class="summary-card">
                        <h4>Netto Jaarlijks Resultaat</h4>
                        <div class="summary-value" id="summary-annual-result">€0</div>
                         <p>Netto cashflow na aftrek van alle jaarlijkse kosten.</p>
                    </div>
                    
                    <div class="summary-card">
                        <h4>Netto Huurrendement</h4>
                        <div class="summary-value" id="summary-rental-yield">0%</div>
                        <p>Direct rendement uit verhuur op jaarbasis.</p>
                    </div>

                    <div class="summary-card">
                        <h4>Verwachte Waardestijging</h4>
                        <div class="summary-value" id="summary-appreciation">0%</div>
                        <p>Gemiddelde prognose per jaar (historisch).</p>
                    </div>
                </div>
                
                <div class="panel-section">
                 <h4>Historische Prijsontwikkeling (2019-2024)</h4>
                 <p>Gebaseerd op officieel onderzoek (zie PDF hieronder) toont deze grafiek de vastgoedwaardestijging, vergeleken met andere populaire Zuid-Europese landen.</p>
                 <div class="chart-container">
                     <canvas id="cumulative-appreciation-chart"></canvas>
                 </div>
                  <a href="https://cdn.prod.website-files.com/66ab26a563f36a02518a48ae/68455b46f6f777ddab5082bf_montenegro_vastgoed_rapport_baysight.pdf" target="_blank" class="btn btn-primary" style="margin-bottom: 1.5rem; width: auto; display: inline-block;">Download Vergelijkend Rapport (PDF)</a>
                </div>

            </div>

            <div class="result-panel" id="financial-panel">
                <div class="panel-section">
                    <h4>Investeringsopbouw</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="investment-breakdown-chart"></canvas>
                    </div>
                    <table class="data-table" id="investment-table"></table>
                </div>
                 <div class="panel-section">
                    <h4>Jaarlijkse Operationele Kosten</h4>
                     <div class="chart-container" style="height: 250px;">
                        <canvas id="annual-costs-chart"></canvas>
                    </div>
                    <table class="data-table" id="costs-table"></table>
                </div>
            </div>

            <div class="result-panel" id="rental-panel">
                <div class="panel-section">
                    <h4>Verhuurinkomsten Prognose (Jaarlijks)</h4>
                    <table class="data-table" id="rental-income-table"></table>
                </div>
                 <div class="panel-section">
                    <h4>Netto Verhuurresultaat</h4>
                    <table class="data-table" id="net-rental-result-table"></table>
                </div>
                <div class="considerations-list">
                    <h4>Aandachtspunten bij verhuur</h4>
                    <ul>
                        <li>De bezettingsgraad is een realistische schatting en kan variëren op basis van marketing, seizoensinvloeden en de kwaliteit van de woning.</li>
                        <li>Huurprijzen zijn marktconform en kunnen fluctueren. Regelmatige evaluatie is aanbevolen.</li>
                        <li>Professioneel beheer via een partij als Bay Sight kan zorgen voor een hogere bezettingsgraad en minder zorgen.</li>
                    </ul>
                </div>
            </div>
            
            <div class="result-panel" id="roi-panel">
                <div class="panel-section">
                    <h4>Analyse van Rendement</h4>
                     <table class="data-table" id="roi-table"></table>
                </div>
                 <div class="considerations-list">
                    <h4>Toelichting Rendement</h4>
                    <ul>
                        <li><b>Netto Huurrendement:</b> Dit is het directe, jaarlijkse rendement uit verhuurinkomsten, afgezet tegen uw totale investering. Het toont de directe winstgevendheid van het pand.</li>
                        <li><b>Cash-on-Cash Rendement:</b> Dit belangrijke kengetal meet hoeveel cash u jaarlijks overhoudt (na alle kosten, inclusief financiering) ten opzichte van het eigen geld dat u daadwerkelijk heeft ingelegd.</li>
                    </ul>
                </div>
            </div>
            
            <div class="result-panel" id="comparison-panel">
                 <div class="panel-section">
                    <h4>Netto Huurrendement Vergelijking</h4>
                    <p>Uw geschatte netto huurrendement in Montenegro vergeleken met vergelijkbare investeringen in andere populaire landen.</p>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="country-comparison-chart"></canvas>
                    </div>
                    <table class="data-table" id="country-comparison-table"></table>
                 </div>
            </div>
            
            <div class="panel-section" id="lead-form-panel">
                <h4>Klaar voor de volgende stap?</h4>
                <p>Vul uw gegevens in om deze volledige berekening per e-mail te ontvangen. We nemen daarnaast vrijblijvend contact met u op om de mogelijkheden te bespreken.</p>
                
                <form id="contact-form">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 200px;">
                            <label for="userName">Naam</label>
                            <input type="text" id="userName" name="name" class="form-control" required placeholder="Uw naam">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px;">
                            <label for="userEmail">E-mailadres</label>
                            <input type="email" id="userEmail" name="email" class="form-control" required placeholder="uw.email@voorbeeld.com">
                        </div>
                    </div>
                    <button type="submit" id="submit-form-btn" class="btn btn-primary" style="width: 100%;">Verstuur en ontvang overzicht</button>
                    <div id="form-status" style="text-align: center; margin-top: 1rem; font-weight: 600;"></div>
                </form>
            </div>


            <div class="result-actions">
                <button class="btn btn-secondary" id="back-to-input">← Aanpassen</button>
                <a href="https://www.baysight.nl/contact/" target="_blank" class="btn btn-secondary">Direct contact opnemen</a>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- STATE VARIABLES ---
    let currentStep = 0;
    let charts = {}; // Object to hold all chart instances
    let lastCalculation = {}; // To store inputs and results for email

    // --- DOM ELEMENTEN ---
    const formSteps = document.querySelectorAll('.input-form');
    const progressSteps = document.querySelectorAll('.progress-step');
    const nextBtn = document.querySelector('.btn-next');
    const prevBtn = document.querySelector('.btn-prev');
    const calculateBtn = document.querySelector('.btn-calculate');
    
    const mainTabs = document.querySelectorAll('.tab');
    const calculatorSections = document.querySelectorAll('.calculator-section');
    
    const resultTabs = document.querySelectorAll('.result-tab');
    const resultPanels = document.querySelectorAll('.result-panel');

    const needFinancingToggle = document.getElementById('needFinancing');
    const financingDetails = document.querySelector('.financing-details');
    
    const usageTypeSelect = document.getElementById('usageType');
    const rentalDetails = document.querySelector('.rental-details');
    const personalUsageWeeksSlider = document.getElementById('personalUsageWeeks');

    const propertyConditionToggle = document.getElementById('propertyCondition');
    
    const contactForm = document.getElementById('contact-form');

    // --- FORM NAVIGATION LOGIC ---
    
    function updateFormState() {
        document.querySelector('.progress-indicator').style.display = (currentStep === 0) ? 'none' : 'flex';

        progressSteps.forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            if (stepNum < currentStep) {
                step.classList.add('completed');
            } else if (stepNum === currentStep) {
                step.classList.add('active');
            }
        });

        formSteps.forEach(form => form.classList.remove('active'));
        document.getElementById(`step-${currentStep}`).classList.add('active');

        prevBtn.disabled = currentStep === 0;
        
        const totalForms = document.querySelectorAll('.input-form').length - 1;
        if (currentStep === totalForms) {
            nextBtn.style.display = 'none';
            calculateBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'inline-block';
            calculateBtn.style.display = 'none';
        }
    }
    
    nextBtn.addEventListener('click', () => {
        const totalForms = document.querySelectorAll('.input-form').length;
        if (currentStep < totalForms - 1) {
            currentStep++;
            updateFormState();
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            updateFormState();
        }
    });
    
    // --- UI INTERACTION LOGIC ---

    needFinancingToggle.addEventListener('change', () => {
        financingDetails.style.display = needFinancingToggle.checked ? 'block' : 'none';
        document.getElementById('yes-financing-label').classList.toggle('active', needFinancingToggle.checked);
        document.getElementById('yes-financing-label').classList.toggle('inactive', !needFinancingToggle.checked);
        document.getElementById('no-financing-label').classList.toggle('active', !needFinancingToggle.checked);
        document.getElementById('no-financing-label').classList.toggle('inactive', needFinancingToggle.checked);
    });
    
    propertyConditionToggle.addEventListener('change', () => {
        const isNewBuild = propertyConditionToggle.checked;
        document.getElementById('new-label').classList.toggle('active', isNewBuild);
        document.getElementById('new-label').classList.toggle('inactive', !isNewBuild);
        document.getElementById('existing-label').classList.toggle('active', !isNewBuild);
        document.getElementById('existing-label').classList.toggle('inactive', isNewBuild);
    });

    usageTypeSelect.addEventListener('change', () => {
        const usage = usageTypeSelect.value;
        const isRental = usage !== 'Vakantiewoning';
        rentalDetails.style.display = (usage === 'Combinatie') ? 'block' : 'none';
        
        if (usage === 'LangeTermijnVerhuur' || usage === 'KorteTermijnVerhuur') {
             personalUsageWeeksSlider.value = 0;
             personalUsageWeeksSlider.dispatchEvent(new Event('input'));
        }
    });

    function setupRangeSlider(sliderId, displayId, suffix = '') {
        const slider = document.getElementById(sliderId);
        const display = document.getElementById(displayId);
        if (slider && display) {
            const update = () => { display.textContent = slider.value + suffix; };
            slider.addEventListener('input', update);
            update();
        }
    }
    setupRangeSlider('personalUsageWeeks', 'personalUsageWeeksValue');

    // --- TAB NAVIGATION ---
    
    mainTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            if (tab.classList.contains('disabled')) return;
            mainTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            calculatorSections.forEach(s => s.classList.remove('active'));
            document.getElementById(`${tab.dataset.tab}-section`).classList.add('active');
            
             if(tab.dataset.tab === 'input') {
                currentStep = 0;
                updateFormState();
             }
        });
    });
    
    document.getElementById('back-to-input').addEventListener('click', () => {
        document.querySelector('.tab[data-tab="input"]').click();
    });

    resultTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            resultTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            resultPanels.forEach(p => p.classList.remove('active'));
            const activePanel = document.getElementById(`${tab.dataset.result}-panel`);
            if (activePanel) {
                activePanel.classList.add('active');
                drawChartsForPanel(tab.dataset.result);
            }
        });
    });

    // --- CALCULATION & FORM SUBMISSION ---
    function gatherInputs() {
         return {
            purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
            furnishingCosts: parseFloat(document.getElementById('furnishingCosts').value) || 0,
            isNewBuild: document.getElementById('propertyCondition').checked,
            propertySize: parseFloat(document.getElementById('propertySize').value) || 0,
            region: document.getElementById('region').value,
            propertyType: document.getElementById('propertyType').value,
            ownCapital: parseFloat(document.getElementById('ownCapital').value) || 0,
            needFinancing: document.getElementById('needFinancing').checked,
            financingInterestRate: parseFloat(document.getElementById('financingInterestRate').value) / 100 || 0,
            financingTerm: parseInt(document.getElementById('financingTerm').value) || 0,
            usageType: document.getElementById('usageType').value,
            personalUsageWeeks: parseInt(document.getElementById('personalUsageWeeks').value) || 0,
            managementPreference: document.getElementById('managementPreference').value,
            investmentHorizon: 10
        };
    }

    calculateBtn.addEventListener('click', () => {
        const inputs = gatherInputs();
        const results = calculateAll(inputs);
        
        lastCalculation = { inputs, results }; 
        
        displayResults(inputs, results);

        const resultsTab = document.querySelector('.tab[data-tab="results"]');
        resultsTab.classList.remove('disabled');
        resultsTab.click();
    });

    async function handleFormSubmit(event) {
        event.preventDefault();
        const statusDiv = document.getElementById('form-status');
        const submitBtn = document.getElementById('submit-form-btn');
        
        const userName = document.getElementById('userName').value;
        const userEmail = document.getElementById('userEmail').value;
        
        if (!userName || !userEmail) {
            statusDiv.textContent = 'Vul alstublieft uw naam en e-mailadres in.';
            statusDiv.style.color = 'var(--error)';
            return;
        }

        const { inputs, results } = lastCalculation;
        if (!inputs || !results) {
            statusDiv.textContent = 'Fout: geen berekening gevonden. Maak eerst een berekening.';
            statusDiv.style.color = 'var(--error)';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Bezig met verzenden...';
        statusDiv.textContent = '';
        
        const formatCurrency = (value) => new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(value);
        const formatPercent = (value) => new Intl.NumberFormat('nl-NL', { style: 'percent', minimumFractionDigits: 2 }).format(value);

        const dataToSend = {
            'Contactpersoon': `${userName} (${userEmail})`,
            '--- Calculator Invoer ---': '',
            ...Object.fromEntries(Object.entries(inputs).map(([key, value]) => [key, typeof value === 'boolean' ? (value ? 'Ja' : 'Nee') : value])),
            '--- Calculator Resultaten (Montenegro) ---': '',
            'Totale Investering': formatCurrency(results.montenegro.totalInvestment),
            'Netto Jaarlijks Resultaat': formatCurrency(results.montenegro.netAnnualCashflow),
            'Netto Huurrendement': formatPercent(results.montenegro.netRentalYield),
        };

        try {
            const response = await fetch('https://formspree.io/f/mjkrgqpr', {
                method: 'POST',
                body: JSON.stringify(dataToSend),
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
            });

            if (response.ok) {
                statusDiv.textContent = 'Bedankt! Uw overzicht is verzonden.';
                statusDiv.style.color = 'var(--success)';
                submitBtn.textContent = 'Verzonden!';
                contactForm.reset();
            } else {
                throw new Error('Server response was not ok.');
            }
        } catch (error) {
            console.error('Form submission error:', error);
            statusDiv.textContent = 'Er is iets misgegaan. Probeer het later opnieuw.';
            statusDiv.style.color = 'var(--error)';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Verstuur en ontvang overzicht';
        }
    }
    
    if (contactForm) {
        contactForm.addEventListener('submit', handleFormSubmit);
    }

    function calculateAll(inputs) {
        const montenegro = calculateCountry(inputs, 'Montenegro');
        const spanje = calculateCountry(inputs, 'Spanje');
        const portugal = calculateCountry(inputs, 'Portugal');
        const italië = calculateCountry(inputs, 'Italië');
        return { montenegro, spanje, portugal, italië };
    }

    function calculateCountry(inputs, country) {
        const results = {};
        const { purchasePrice, isNewBuild, propertySize, furnishingCosts, managementPreference, usageType, personalUsageWeeks, needFinancing, financingInterestRate, financingTerm, ownCapital } = inputs;

        let params = {};
        
        switch(country) {
            case 'Montenegro':
                params = { 
                    grossYieldRate: 0.065, 
                    managementFeeRate: { "Volledig uitbesteden": 0.10, "Gedeeltelijk uitbesteden": 0.08, "Zelf actief beheren": 0.05 }[managementPreference],
                    effectiveTaxRate: 0.1187,
                    taxOnGross: true
                };
                break;
            case 'Spanje':
                params = { 
                    totalTransactionCostRate: 0.116,
                    grossYieldRate: 0.06, 
                    managementFeeRate: 0.10,
                    effectiveTaxRate: 0.19, // AANGEPAST naar 19%
                    taxOnGross: false
                };
                break;
            case 'Portugal':
                params = { 
                    totalTransactionCostRate: 0.073,
                    grossYieldRate: 0.055, 
                    managementFeeRate: 0.08,
                    effectiveTaxRate: 0.28,
                    taxOnGross: true
                };
                break;
            case 'Italië':
                params = { 
                    totalTransactionCostRate: 0.106,
                    grossYieldRate: 0.055, 
                    managementFeeRate: 0.10,
                    effectiveTaxRate: 0.21,
                    taxOnGross: true
                };
                break;
        }

        results.purchasePrice = purchasePrice || 0;
        let totalAdditionalCosts = 0;
        
        if (country === 'Montenegro') {
            if (results.purchasePrice <= 150000) {
                results.transferTax = results.purchasePrice * 0.03;
            } else if (results.purchasePrice <= 500000) {
                results.transferTax = 4500 + (results.purchasePrice - 150000) * 0.05;
            } else {
                results.transferTax = 22000 + (results.purchasePrice - 500000) * 0.06;
            }
            if(isNewBuild) results.transferTax = 0;

            results.notaryCosts = 400;
            results.registrationCosts = 50;
            results.brokerageCosts = 0;
            results.lawyerCosts = results.purchasePrice * 0.01;
            results.furnishingCosts = furnishingCosts;
            totalAdditionalCosts = results.transferTax + results.notaryCosts + results.registrationCosts + results.brokerageCosts + results.lawyerCosts + results.furnishingCosts;
        } else {
            totalAdditionalCosts = results.purchasePrice * params.totalTransactionCostRate + furnishingCosts;
        }

        results.totalInvestment = results.purchasePrice + totalAdditionalCosts;

        results.annualFinancingCost = 0;
        results.financingAmount = 0;

        if(country === 'Montenegro' && needFinancing) {
            results.financingAmount = Math.max(0, results.totalInvestment - ownCapital);
            if (results.financingAmount > 0 && financingTerm > 0) {
                if (financingInterestRate > 0) {
                    const r = financingInterestRate / 12;
                    const n = financingTerm * 12;
                    const monthlyPayment = (results.financingAmount * (r * Math.pow(1 + r, n))) / (Math.pow(1 + r, n) - 1);
                    if (isFinite(monthlyPayment)) {
                        results.annualFinancingCost = monthlyPayment * 12;
                    }
                }
            }
        }
        
        results.ownCapitalContribution = results.totalInvestment - (results.financingAmount || 0);

        const annualPropertyTaxRate = 0.007;
        const annualInsuranceRate = 0.002;
        const annualMaintenanceRate = 0.008;

        results.annualPropertyTax = results.purchasePrice * annualPropertyTaxRate;
        results.annualInsurance = results.purchasePrice * annualInsuranceRate;
        results.annualMaintenance = results.purchasePrice * annualMaintenanceRate;
        results.totalAnnualCostsBeforeFinancing = results.annualPropertyTax + results.annualInsurance + results.annualMaintenance;
        
        let grossAnnualRentalIncome = 0;
        if (usageType !== 'Vakantiewoning' && results.purchasePrice > 0) {
            grossAnnualRentalIncome = results.purchasePrice * params.grossYieldRate;
        }
        
        results.grossAnnualRentalIncome = grossAnnualRentalIncome; 
        results.managementFeeRate = params.managementFeeRate; 
        results.rentalManagementFee = grossAnnualRentalIncome * results.managementFeeRate;
        results.netAnnualRentalIncome = grossAnnualRentalIncome - results.rentalManagementFee;

        let taxAmount = 0;
        if(params.taxOnGross){
            taxAmount = results.grossAnnualRentalIncome * params.effectiveTaxRate;
        } else {
            const netIncomeBeforeTax = results.netAnnualRentalIncome - results.totalAnnualCostsBeforeFinancing;
            taxAmount = Math.max(0, netIncomeBeforeTax) * params.effectiveTaxRate;
        }
        results.taxAmount = taxAmount;
        results.effectiveTaxRate = params.effectiveTaxRate;
        results.taxOnGross = params.taxOnGross;

        results.netAnnualCashflow = results.netAnnualRentalIncome - results.totalAnnualCostsBeforeFinancing - results.annualFinancingCost - results.taxAmount;
        
        results.netRentalYield = (results.totalInvestment > 0) ? results.netAnnualCashflow / results.totalInvestment : 0;
        results.cashOnCashReturn = (results.ownCapitalContribution > 0) ? results.netAnnualCashflow / results.ownCapitalContribution : 0;
        
        results.avgAppreciation = 0.125; 

        return results;
    }


    function displayResults(inputs, allResults) {
        const { montenegro } = allResults;
        const formatCurrency = (value) => new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(value);
        const formatPercent = (value, digits = 2) => new Intl.NumberFormat('nl-NL', { style: 'percent', minimumFractionDigits: digits, maximumFractionDigits: digits }).format(value);

        document.getElementById('summary-property-type').textContent = inputs.propertyType;
        document.getElementById('summary-region').textContent = document.querySelector(`#region option[value="${inputs.region}"]`).textContent;
        document.getElementById('summary-total-investment').textContent = formatCurrency(montenegro.totalInvestment);
        document.getElementById('summary-annual-result').textContent = formatCurrency(montenegro.netAnnualCashflow);
        document.getElementById('summary-rental-yield').textContent = formatPercent(montenegro.netRentalYield);
        document.getElementById('summary-appreciation').textContent = formatPercent(montenegro.avgAppreciation);
        
        document.getElementById('investment-table').innerHTML = `
            <tbody>
                <tr><td>Aankoopprijs</td><td>${formatCurrency(montenegro.purchasePrice)}</td></tr>
                <tr><td>Overdrachtsbelasting</td><td>${formatCurrency(montenegro.transferTax)}</td></tr>
                <tr><td>Notariskosten</td><td>${formatCurrency(montenegro.notaryCosts)}</td></tr>
                <tr><td>Registratiekosten</td><td>${formatCurrency(montenegro.registrationCosts)}</td></tr>
                <tr><td>Advocaatkosten</td><td>${formatCurrency(montenegro.lawyerCosts)}</td></tr>
                <tr><td>Inrichtingskosten</td><td>${formatCurrency(montenegro.furnishingCosts)}</td></tr>
                <tr class="total-row"><td>Totale Investering</td><td>${formatCurrency(montenegro.totalInvestment)}</td></tr>
                <tr><td>Eigen Vermogen</td><td>${formatCurrency(montenegro.ownCapitalContribution)}</td></tr>
                <tr><td>Financiering</td><td>${formatCurrency(montenegro.financingAmount || 0)}</td></tr>
            </tbody>`;

        const totalAnnualCosts = montenegro.totalAnnualCostsBeforeFinancing + montenegro.annualFinancingCost + montenegro.taxAmount;
        document.getElementById('costs-table').innerHTML = `
                 <tbody>
                    <tr><td>Onroerendgoedbelasting</td><td>${formatCurrency(montenegro.annualPropertyTax)}</td></tr>
                    <tr><td>Verzekering</td><td>${formatCurrency(montenegro.annualInsurance)}</td></tr>
                    <tr><td>Onderhoud & VvE</td><td>${formatCurrency(montenegro.annualMaintenance)}</td></tr>
                    <tr><td>Jaarlijkse Financieringskosten</td><td>${formatCurrency(montenegro.annualFinancingCost)}</td></tr>
                    <tr><td>Inkomstenbelasting</td><td>${formatCurrency(montenegro.taxAmount)}</td></tr>
                    <tr class="total-row"><td>Totale Jaarlijkse Kosten</td><td>${formatCurrency(totalAnnualCosts)}</td></tr>
                </tbody>`;
        
        const rentalIncomeTable = document.getElementById('rental-income-table').parentElement;
        const netRentalResultTable = document.getElementById('net-rental-result-table').parentElement;
        if (inputs.usageType !== 'Vakantiewoning') {
             rentalIncomeTable.style.display = 'block';
             netRentalResultTable.style.display = 'block';
             document.getElementById('rental-income-table').innerHTML = `<tbody>
                     <tr><td>Type verhuur</td><td>${inputs.usageType.includes('Korte') ? 'Korte Termijn' : (inputs.usageType.includes('Lange') ? 'Lange Termijn' : 'Combinatie')}</td></tr>
                     <tr><td>Bruto Huurinkomsten</td><td>${formatCurrency(montenegro.grossAnnualRentalIncome)}</td></tr>
                     <tr><td>Beheerkosten (${formatPercent(montenegro.managementFeeRate, 0)})</td><td>-${formatCurrency(montenegro.rentalManagementFee)}</td></tr>
                     <tr class="total-row"><td>Netto Huurinkomsten</td><td>${formatCurrency(montenegro.netAnnualRentalIncome)}</td></tr>
                 </tbody>`;
             document.getElementById('net-rental-result-table').innerHTML = `<tbody>
                     <tr><td>Netto Huurinkomsten</td><td>${formatCurrency(montenegro.netAnnualRentalIncome)}</td></tr>
                     <tr><td>Totale Jaarlijkse Kosten</td><td>-${formatCurrency(totalAnnualCosts)}</td></tr>
                     <tr class="total-row"><td>Netto Cashflow</td><td>${formatCurrency(montenegro.netAnnualCashflow)}</td></tr>
                 </tbody>`;
        } else {
            rentalIncomeTable.style.display = 'none';
            netRentalResultTable.style.display = 'block';
            document.getElementById('net-rental-result-table').innerHTML = `<tbody>
                     <tr><td>Gebruik</td><td>Alleen eigen gebruik</td></tr>
                     <tr><td>Jaarlijkse Kosten</td><td>-${formatCurrency(totalAnnualCosts)}</td></tr>
                     <tr class="total-row"><td>Netto Jaarlijkse Kosten</td><td>${formatCurrency(montenegro.netAnnualCashflow)}</td></tr>
                 </tbody>`;
        }
        
        document.getElementById('roi-table').innerHTML = `<tbody>
                <tr>
                    <td>Netto Huurrendement 
                        <span class="tooltip"><i class="tooltip-icon">i</i>
                        <span class="tooltip-text">Meet de winstgevendheid van de huurinkomsten t.o.v. de totale investering.<br><b>Formule:</b> (Netto Cashflow / Totale Investering) * 100%</span></span>
                    </td>
                    <td>${formatPercent(montenegro.netRentalYield)}</td>
                </tr>
                 <tr>
                    <td>Cash-on-Cash Rendement
                        <span class="tooltip"><i class="tooltip-icon">i</i>
                        <span class="tooltip-text">Meet de cashflow t.o.v. het daadwerkelijk geïnvesteerde eigen vermogen.<br><b>Formule:</b> (Netto Cashflow / Eigen Vermogen) * 100%</span></span>
                    </td>
                    <td>${formatPercent(montenegro.cashOnCashReturn)}</td>
                </tr>
            </tbody>`;
        
        const countryData = {
            'Montenegro': { yield: allResults.montenegro.netRentalYield, tax: allResults.montenegro.taxAmount, taxRate: allResults.montenegro.effectiveTaxRate, taxBase: allResults.montenegro.taxOnGross ? 'bruto' : 'netto', netCashflow: allResults.montenegro.netAnnualCashflow, color: '#d4915f' },
            'Spanje': { yield: allResults.spanje.netRentalYield, tax: allResults.spanje.taxAmount, taxRate: allResults.spanje.effectiveTaxRate, taxBase: allResults.spanje.taxOnGross ? 'bruto' : 'netto', netCashflow: allResults.spanje.netAnnualCashflow, color: '#F0B429' },
            'Portugal': { yield: allResults.portugal.netRentalYield, tax: allResults.portugal.taxAmount, taxRate: allResults.portugal.effectiveTaxRate, taxBase: allResults.portugal.taxOnGross ? 'bruto' : 'netto', netCashflow: allResults.portugal.netAnnualCashflow, color: '#00A5CF' },
            'Italië': { yield: allResults.italië.netRentalYield, tax: allResults.italië.taxAmount, taxRate: allResults.italië.effectiveTaxRate, taxBase: allResults.italië.taxOnGross ? 'bruto' : 'netto', netCashflow: allResults.italië.netAnnualCashflow, color: '#31C48D' }
        };

        const comparisonTable = document.getElementById('country-comparison-table');
        comparisonTable.innerHTML = `
            <thead>
              <tr>
                <th>Land</th>
                <th>Netto Inkomen (Jaarlijks)</th>
                <th>Inkomstenbelasting (Jaarlijks)</th>
                <th>Netto Huurrendement</th>
              </tr>
            </thead>
            <tbody>
            ${Object.keys(countryData).map(country => {
            const data = countryData[country];
            const countryClass = country.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            const taxRateFormatted = (data.taxRate === 0.1187) ? formatPercent(data.taxRate, 2) : formatPercent(data.taxRate, 0);
            return `<tr>
                     <td><span class="country-badge ${countryClass}">${country}</span></td>
                     <td><strong>${formatCurrency(data.netCashflow)}</strong></td>
                     <td>
                        <strong>${formatCurrency(data.tax)}</strong>
                        <small style="display: block; color: var(--text-light);">${taxRateFormatted} op ${data.taxBase}</small>
                     </td>
                     <td><strong>${formatPercent(data.yield)}</strong></td>
                 </tr>`;
            }).join('')}
            </tbody>`;

        drawChartsForPanel('summary', inputs, allResults, countryData);
        // Ensure all charts are drawn initially
        Object.keys(charts).forEach(key => charts[key].destroy());
        charts = {};
        drawChartsForPanel('summary', inputs, allResults, countryData);
        drawChartsForPanel('financial', inputs, allResults, countryData);
        drawChartsForPanel('comparison', inputs, allResults, countryData);
    }
    
    function destroyChart(chartId) {
        if (charts[chartId]) {
            charts[chartId].destroy();
            delete charts[chartId];
        }
    }

    function drawChartsForPanel(panelId) {
        const { inputs, results } = lastCalculation;
        if (!inputs || !results) return;

        const countryData = {
            'Montenegro': { yield: results.montenegro.netRentalYield, tax: results.montenegro.taxAmount, color: '#d4915f' },
            'Spanje': { yield: results.spanje.netRentalYield, tax: results.spanje.taxAmount, color: '#F0B429' },
            'Portugal': { yield: results.portugal.netRentalYield, tax: results.portugal.taxAmount, color: '#00A5CF' },
            'Italië': { yield: results.italië.netRentalYield, tax: results.italië.taxAmount, color: '#31C48D' }
        };

         const { montenegro } = results;
          Chart.defaults.font.family = "'Open Sans', sans-serif";
          Chart.defaults.color = 'var(--text-secondary)';
          const sharedOptions = { responsive: true, maintainAspectRatio: false };

        if(panelId === 'summary'){
            destroyChart('cumulative-appreciation-chart');
            const appreciationCtx = document.getElementById('cumulative-appreciation-chart');
             if(appreciationCtx) {
                const priceDevelopmentData = {
                    labels: ['2019', '2020', '2021', '2022', '2023', '2024'],
                    datasets: [
                        { label: 'Montenegro', data: [100, 92.9, 116.7, 134.4, 160.6, 180.1], borderColor: '#d4915f', backgroundColor: 'transparent', pointBackgroundColor: '#d4915f', tension: 0.1 },
                        { label: 'Spanje', data: [100, 102.1, 105.9, 113.7, 118.3, 128.1], borderColor: '#F0B429', backgroundColor: 'transparent', pointBackgroundColor: '#F0B429', tension: 0.1 },
                        { label: 'Portugal', data: [100, 106.0, 117.8, 128.0, 139.1, 150.8], borderColor: '#00A5CF', backgroundColor: 'transparent', pointBackgroundColor: '#00A5CF', tension: 0.1 },
                        { label: 'Italië', data: [100, 101.5, 103.5, 105.7, 107.9, 115.1], borderColor: '#31C48D', backgroundColor: 'transparent', pointBackgroundColor: '#31C48D', tension: 0.1 }
                    ]
                };
                charts['cumulative-appreciation-chart'] = new Chart(appreciationCtx, {
                    type: 'line',
                    data: priceDevelopmentData,
                    options: { ...sharedOptions, scales: { y: { beginAtZero: false, title: { display: true, text: 'Prijsindex (2019 = 100)' } } } }
                });
             }
        }
        if(panelId === 'financial'){
             destroyChart('investment-breakdown-chart');
             const investmentCtx = document.getElementById('investment-breakdown-chart');
             if (investmentCtx) {
                charts['investment-breakdown-chart'] = new Chart(investmentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aankoopprijs', 'Belastingen', 'Notaris/Reg.', 'Advocaat', 'Inrichting'],
                        datasets: [{ data: [montenegro.purchasePrice, montenegro.transferTax, montenegro.notaryCosts + montenegro.registrationCosts, montenegro.lawyerCosts, montenegro.furnishingCosts], backgroundColor: ['#042943', '#d4915f', '#00A5CF', '#627D98', '#F0B429'], borderWidth: 0 }]
                    },
                    options: { ...sharedOptions, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
                });
             }
            
            destroyChart('annual-costs-chart');
             const costsCtx = document.getElementById('annual-costs-chart');
             if (costsCtx) {
                const costsData = [montenegro.annualPropertyTax, montenegro.annualInsurance, montenegro.annualMaintenance, montenegro.annualFinancingCost, montenegro.taxAmount].filter(v => v > 0);
                const costsLabels = ['Vastgoedbelasting', 'Verzekering', 'Onderhoud/VvE', 'Financiering', 'Inkomstenbelasting'].filter((_, i) => [montenegro.annualPropertyTax, montenegro.annualInsurance, montenegro.annualMaintenance, montenegro.annualFinancingCost, montenegro.taxAmount][i] > 0);

                charts['annual-costs-chart'] = new Chart(costsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: costsLabels,
                        datasets: [{ data: costsData, backgroundColor: ['#042943', '#d4915f', '#00A5CF', '#627D98', '#F0B429'], borderWidth: 0 }]
                    },
                    options: { ...sharedOptions, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
                });
             }
        }
        if(panelId === 'comparison') {
             destroyChart('country-comparison-chart');
             const comparisonCtx = document.getElementById('country-comparison-chart');
             if (comparisonCtx) {
                charts['country-comparison-chart'] = new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(countryData),
                        datasets: [
                            { 
                                label: 'Netto Huurrendement', 
                                data: Object.values(countryData).map(d => d.yield * 100), 
                                backgroundColor: Object.values(countryData).map(d => d.color) 
                            },
                        ]
                    },
                    options: { ...sharedOptions, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { callback: value => value + '%' } } } }
                });
             }
        }
    }

    // Initialize the form state on page load
    updateFormState();
    // Initialize toggles and sliders
    needFinancingToggle.dispatchEvent(new Event('change'));
    propertyConditionToggle.dispatchEvent(new Event('change'));
    usageTypeSelect.dispatchEvent(new Event('change'));
});

</script>
</body>
</html>
