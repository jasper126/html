<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAY SIGHT Woning Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* Primaire kleuren (Aangepaste Baysight huisstijl) */
            --primary-blue: #042943;
            --primary-orange: #d4915f;
            --primary-turquoise: #00A5CF;
            
            /* Secundaire kleuren */
            --secondary-light: #F0F4F8;
            --secondary-medium: #D9E2EC;
            --secondary-dark: #627D98;
            
            /* Functionele kleuren */
            --success: #31C48D;
            --warning: #F0B429;
            --error: #E12D39;
            
            /* Tekst kleuren */
            --text-primary: #102A43;
            --text-secondary: #486581;
            --text-light: #829AB1;
            
            /* Achtergrond kleuren */
            --bg-light: #FFFFFF;
            --bg-off-white: #F8FAFC;
            --bg-highlight: #EFF6FF;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-off-white);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .baysight-calculator-container {
            width: 100%;
            max-width: 1160px;
            margin: 0 auto;
            background-color: var(--bg-light);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .calculator-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .calculator-header h2 {
            margin: 0;
            font-size: 3.5rem;
            font-family: 'DM Serif Display', serif;
            font-weight: 400;
            color: var(--primary-orange);
            text-transform: uppercase;
        }

        .calculator-tabs {
            display: flex;
            background-color: var(--secondary-light);
            border-bottom: 1px solid var(--secondary-medium);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1 1 auto;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab:hover {
            background-color: var(--bg-highlight);
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-orange);
            background-color: var(--bg-light);
        }
        .tab.disabled {
            color: var(--text-light);
            cursor: not-allowed;
            background-color: var(--secondary-light);
        }


        .calculator-section {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calculator-section.active {
            display: block;
        }

        .progress-indicator {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--secondary-medium);
            padding-bottom: 1rem;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            position: relative;
            color: var(--text-light);
            font-weight: 500;
        }

        .progress-step.active {
            color: var(--primary-blue);
            font-weight: 700;
        }

        .progress-step.completed {
            color: var(--primary-blue);
            font-weight: 500;
        }
        .progress-step.completed::before {
            content: '✔';
            color: var(--success);
            margin-right: 0.5rem;
        }


        .progress-step::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1rem;
            height: 1rem;
            background-color: var(--secondary-medium);
            border-radius: 50%;
            border: 2px solid var(--bg-off-white);
            transition: background-color 0.3s ease;
        }

        .progress-step.active::after {
            background-color: var(--primary-orange);
            transform: translateX(-50%) scale(1.2);
        }

        .progress-step.completed::after {
            background-color: var(--success);
        }

        .input-form {
            display: none;
        }

        .input-form.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            box-sizing: border-box;
            display: block;
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-light);
            border: 1px solid var(--secondary-medium);
            border-radius: 4px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-turquoise);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 165, 207, 0.25);
        }
        
        .label-with-tooltip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .label-with-tooltip label {
            margin-bottom: 0;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--secondary-medium);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        
        input[type="range"]:hover {
            opacity: 1;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary-orange);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--primary-orange);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }


        .range-value {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .range-value .current-value {
            font-weight: 700;
            color: var(--primary-blue);
            background-color: var(--bg-highlight);
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
        }
        
        .toggle-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--secondary-light);
            padding: 0.75rem;
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--secondary-dark);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-orange);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label-text {
            font-weight: 600;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .toggle-label-text.inactive {
            color: var(--text-light);
            font-weight: 500;
        }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background-color: #c07e4d;
            color: white;
            box-shadow: 0 4px 10px rgba(212, 145, 95, 0.4);
        }

        .btn-secondary {
            background-color: var(--secondary-medium);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            color: white;
        }

        .btn:disabled {
            background-color: var(--secondary-medium);
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn:disabled:hover {
            background-color: var(--secondary-medium);
            color: var(--text-primary);
        }

        .results-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--secondary-medium);
        }
        .results-tabs::-webkit-scrollbar {
            height: 5px;
        }
        .results-tabs::-webkit-scrollbar-thumb {
            background: var(--secondary-medium); 
            border-radius: 10px;
        }


        .result-tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* Align with border */
            white-space: nowrap;
        }

        .result-tab:hover {
            color: var(--primary-blue);
        }

        .result-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-orange);
        }

        .result-panel {
            display: none;
            animation: fadeIn 0.5s;
        }

        .result-panel.active {
            display: block;
        }

        .summary-header {
            margin-bottom: 1.5rem;
        }
        .summary-header h3 {
            color: var(--primary-blue);
        }

        .property-info {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background-color: var(--bg-light);
            border: 1px solid var(--secondary-light);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
        }

        .summary-card h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-blue);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-orange);
        }

        .summary-chart-container {
            height: 250px;
        }

        .panel-section {
            margin-bottom: 2.5rem;
        }

        .panel-section h4 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--secondary-light);
            padding-bottom: 0.5rem;
        }

        .chart-container {
            height: 350px;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--secondary-medium);
            vertical-align: middle;
        }

        .data-table th {
            background-color: var(--secondary-light);
            font-weight: 600;
        }
        .data-table tbody tr:hover {
            background-color: var(--bg-highlight);
        }
        .data-table .total-row td {
            font-weight: 700;
            color: var(--primary-blue);
        }
        
        .data-table td.numeric-cell {
            text-align: right;
            font-feature-settings: "tnum"; /* Tabular nums for alignment */
            font-weight: 500;
        }
        .data-table td.numeric-cell strong {
            font-weight: 700;
        }


        .considerations-list {
            background-color: var(--bg-highlight);
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 5px solid var(--primary-turquoise);
            margin-top: 2rem;
        }
        .considerations-list h4 {
            margin-top: 0;
            color: var(--primary-blue);
        }

        .considerations-list ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .considerations-list li {
            margin-bottom: 0.75rem;
        }
        
        .rental-summary-info {
            background-color: var(--bg-highlight);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-around;
            text-align: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .rental-summary-info div {
            flex: 1;
            min-width: 150px;
        }

        .rental-summary-info .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            display: block;
            font-size: 0.9rem;
        }
        
        .rental-summary-info .info-value {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary-blue);
        }


        .result-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--secondary-medium);
        }
        
        .country-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }

        .country-badge.montenegro { background-color: var(--primary-orange); }
        .country-badge.spanje { background-color: var(--warning); color: var(--text-primary); }
        .country-badge.portugal { background-color: var(--primary-turquoise); }
        .country-badge.italie { background-color: var(--success); }
        
        .country-cell-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            vertical-align: middle;
        }

        .tooltip .tooltip-icon {
            font-style: normal;
            font-weight: 700;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--secondary-dark);
            color: white;
            font-size: 12px;
            margin-left: 8px;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--primary-blue);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--primary-blue) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .cta-section {
            background-color: var(--secondary-light);
            border-radius: 8px;
            padding: 2.5rem;
            margin-top: 2rem;
            border: 1px solid var(--secondary-medium);
        }

        .cta-content {
            display: flex;
            align-items: center;
            gap: 2.5rem;
        }
        
        .cta-icon-container {
            flex-shrink: 0;
            color: var(--primary-orange);
        }

        .cta-icon-container svg {
            width: 80px;
            height: 80px;
        }

        .cta-text {
            flex-grow: 1;
        }

        .cta-text h2 {
            font-family: 'DM Serif Display', serif;
            color: var(--primary-blue);
            font-size: 2rem;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .cta-text p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }
        
        .cta-form-inputs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .cta-form-inputs .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn-cta {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
        }
        
        /* STYLES FOR CUSTOM MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(4, 41, 67, 0.6);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            display: block;
            opacity: 1;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: var(--bg-light);
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.visible {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--secondary-medium);
            padding: 1rem 1.5rem;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary-blue);
            font-family: 'DM Serif Display', serif;
            font-size: 1.5rem;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2.5rem;
            font-weight: 300;
            line-height: 1;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
        }
        .modal-close-btn:hover {
            color: var(--error);
        }
        .modal-body {
            padding: 1.5rem;
            line-height: 1.6;
        }
        .modal-body p {
            margin: 0;
        }


        @media (max-width: 1159px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body { padding: 0; }
            .baysight-calculator-container { border-radius: 0; }
            .calculator-section { padding: 1.5rem; }
            .calculator-header h2 { font-size: 2.5rem; }

            .progress-indicator {
                flex-direction: column;
                border-bottom: none;
                gap: 0.5rem;
                padding-bottom: 0;
            }

            .progress-step {
                text-align: left;
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--secondary-medium);
            }

            .progress-step::after {
                display: none;
            }
            
            .form-navigation {
                flex-direction: column-reverse;
                gap: 1rem;
            }

            .result-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                box-sizing: border-box;
            }
            
            .cta-content {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }
            .cta-form-inputs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="baysight-calculator-container" id="main-container">
        <div class="calculator-header">
            <h2>Woning Calculator</h2>
        </div>

        <div class="calculator-tabs">
            <div class="tab active" data-tab="input">Start & Invoer</div>
            <div class="tab disabled" data-tab="results">Resultaten</div>
        </div>
        
        <div class="calculator-section active" id="input-section">
            <div class="progress-indicator">
                <div class="progress-step active" data-step="1">1. Woning</div>
                <div class="progress-step" data-step="2">2. Financieel</div>
                <div class="progress-step" data-step="3">3. Gebruik</div>
                <div class="progress-step" data-step="4">4. Voorkeuren</div>
            </div>
            
            <div class="input-form active" id="step-0">
                <div class="panel-section">
                    <h4>Uitleg van de Calculator</h4>
                    <p>Deze calculator is ontworpen om u een gedetailleerd en realistisch inzicht te geven in het potentiële rendement van een vastgoedinvestering. Onze berekeningen zijn niet zomaar schattingen; ze zijn gebaseerd op een diepgaande analyse van de meest recente, openbare data.</p>
                    
                    <h5>Onze Databronnen</h5>
                    <ul>
                        <li><strong>Nationale Statistische Bureaus:</strong> Gegevens over vastgoedprijzen, transactievolumes en economische indicatoren zijn afkomstig van de officiële CBS-equivalenten van elk land, zoals MONSTAT (Montenegro), INE (Spanje), INE Portugal, en ISTAT (Italië).</li>
                        <li><strong>Belastingautoriteiten:</strong> Alle berekeningen van overdrachtsbelasting, jaarlijkse eigendomsbelasting en belasting op huurinkomsten zijn gebaseerd op de officiële, meest recente tarieven en wetgeving van de respectievelijke belastingdiensten.</li>
                        <li><strong>Onafhankelijke Marktanalyse:</strong> Voor parameters zoals gemiddelde huurrendementen en beheerkosten maken we gebruik van data van gerenommeerde, onafhankelijke vastgoedanalisten zoals de Global Property Guide, en analyses van financiële instellingen zoals PwC en BBVA Research.</li>
                    </ul>

                    <h5>Transparante Berekeningen</h5>
                    <p>De tool berekent dynamisch de kosten en opbrengsten voor uw specifieke situatie. Wanneer u een aankoopprijs invoert, wordt voor elk land een parallelle berekening gemaakt van de transactiekosten en het te verwachten netto huurrendement. Dit stelt u in staat om een eerlijke, data-gedreven vergelijking te maken.</p>
                    
                    <div class="considerations-list" style="border-left-color: var(--warning);">
                            <h4>Disclaimer</h4>
                            <p>Hoewel we streven naar maximale nauwkeurigheid, dient deze calculator als een indicatief hulpmiddel. De vastgoedmarkt is dynamisch en werkelijke resultaten kunnen afwijken. Deze berekening vormt geen financieel advies. Wij raden u ten zeerste aan om contact op te nemen voor een persoonlijk adviesgesprek om uw specifieke situatie te bespreken.</p>
                    </div>
                </div>
            </div>

            <div class="input-form" id="step-1">
                <h3>Woninggegevens in Montenegro</h3>
                
                <div class="form-group">
                    <label for="purchasePrice">Aankoopprijs (€)</label>
                    <input type="number" id="purchasePrice" class="form-control" placeholder="bv. 250000" value="250000" min="0">
                </div>

                <div class="form-group">
                    <label for="furnishingCosts">Inrichtingskosten (€) (Optioneel)</label>
                    <input type="number" id="furnishingCosts" class="form-control" placeholder="bv. 20000" min="0">
                </div>
                
                <div class="form-group">
                    <label for="propertyCondition">Staat van de woning</label>
                    <select id="propertyCondition" class="form-control">
                        <option value="new">Nieuwbouw</option>
                        <option value="existing">Bestaande bouw</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="propertySize">Woonoppervlakte (m²)</label>
                    <input type="number" id="propertySize" class="form-control" min="20" placeholder="bv. 80" value="80">
                </div>
                
                <div class="form-group">
                    <div class="label-with-tooltip">
                        <label for="region">Regio</label>
                        <span class="tooltip">
                            <i class="tooltip-icon">i</i>
                            <span class="tooltip-text">De gekozen regio beïnvloedt de geschatte huurprijzen en de bezettingsgraad, wat direct impact heeft op het berekende rendement. Kustgebieden hebben doorgaans een hoger toeristisch potentieel.</span>
                        </span>
                    </div>
                    <select id="region" class="form-control">
                        <option value="Kotor">Baai van Kotor</option>
                        <option value="Budva">Budva Riviera</option>
                        <option value="Tivat">Tivat & Luštica</option>
                        <option value="Bar">Bar & Ulcinj</option>
                        <option value="Noord">Noord (Binnenland)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="propertyType">Type woning</label>
                    <select id="propertyType" class="form-control">
                        <option value="Appartement">Appartement</option>
                        <option value="Villa">Villa</option>
                        <option value="Landhuis">Landhuis</option>
                    </select>
                </div>
            </div>

            <div class="input-form" id="step-2">
                <h3>Financiële gegevens</h3>
                
                <div class="form-group">
                    <label for="ownCapital">Beschikbaar eigen vermogen (€)</label>
                    <input type="number" id="ownCapital" class="form-control" placeholder="bv. 150000" value="150000" min="0">
                    <div id="capital-warning" style="color: var(--warning); font-size: 0.9rem; margin-top: 0.5rem; display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label>Heeft u financiering nodig? <small style="font-weight: 400; color: var(--text-secondary);">(bv. via opname overwaarde)</small></label>
                    <div class="toggle-switch-container">
                        <span class="toggle-label-text active" id="no-financing-label">Nee</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="needFinancing">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label-text inactive" id="yes-financing-label">Ja</span>
                    </div>
                </div>
                
                <div class="financing-details" style="display: none;">
                    <div class="form-group">
                        <label for="financingInterestRate">Rentepercentage (%)</label>
                        <input type="number" id="financingInterestRate" class="form-control" min="0" max="20" step="0.1" value="5.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="financingTerm">Looptijd financiering (jaren)</label>
                        <input type="number" id="financingTerm" class="form-control" min="1" max="30" value="20">
                    </div>
                </div>
            </div>

            <div class="input-form" id="step-3">
                <h3>Gebruiksgegevens</h3>
                
                <div class="form-group">
                    <label for="usageType">Primair gebruiksdoel</label>
                    <select id="usageType" class="form-control">
                        <option value="Combinatie">Combinatie (Eigen gebruik & Verhuur)</option>
                        <option value="Vakantiewoning">Alleen eigen gebruik (Vakantiewoning)</option>
                        <option value="LangeTermijnVerhuur">Volledige Lange Termijn Verhuur</option>
                        <option value="KorteTermijnVerhuur">Volledige Korte Termijn Verhuur (Vakantie)</option>
                    </select>
                </div>
                
                <div class="rental-details">
                        <div class="form-group">
                            <label for="personalUsageWeeks">Aantal weken per jaar voor eigen gebruik</label>
                            <input type="range" id="personalUsageWeeks" class="form-range" min="0" max="52" value="4">
                            <div class="range-value">
                                <span>0 weken</span>
                                <span class="current-value" id="personalUsageWeeksValue">4</span>
                                <span>52 weken</span>
                            </div>
                        </div>
                </div>
            </div>

            <div class="input-form" id="step-4">
                <h3>Voorkeuren</h3>
                <div class="form-group">
                    <label for="managementPreference">Voorkeur voor beheer (indien verhuur)</label>
                    <select id="managementPreference" class="form-control">
                        <option value="Volledig uitbesteden">Volledig uitbesteden (Aanbevolen)</option>
                        <option value="Gedeeltelijk uitbesteden">Gedeeltelijk uitbesteden</option>
                        <option value="Zelf actief beheren">Zelf actief beheren</option>
                    </select>
                </div>
            </div>
            
            <div class="form-navigation">
                <button class="btn btn-secondary btn-prev" disabled>Vorige</button>
                <button class="btn btn-primary btn-next">Volgende</button>
                <button class="btn btn-primary btn-calculate" style="display: none;">Bereken</button>
            </div>
        </div>
        
        <div class="calculator-section" id="results-section">
            <div class="results-tabs">
                <div class="result-tab active" data-result="summary">Samenvatting</div>
                <div class="result-tab" data-result="financial">Investering & Kosten</div>
                <div class="result-tab" data-result="rental">Verhuurpotentieel</div>
            </div>
            
            <div class="result-panel active" id="summary-panel">
                <div class="summary-header">
                    <h3>Uw Investeringsprofiel</h3>
                    <div class="property-info">
                        <span id="summary-property-type">Appartement</span> in 
                        <span id="summary-region">Baai van Kotor</span>,
                        <span>Montenegro</span>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>Totale Investering</h4>
                        <div class="summary-value" id="summary-total-investment">€0</div>
                        <p>Bestaat uit aankoopprijs en alle bijkomende kosten.</p>
                    </div>
                    
                    <div class="summary-card">
                        <h4>Netto Jaarlijks Resultaat</h4>
                        <div class="summary-value" id="summary-annual-result">€0</div>
                        <p>Netto cashflow na aftrek van alle jaarlijkse kosten.</p>
                    </div>
                    
                    <div class="summary-card">
                        <h4>Netto Huurrendement</h4>
                        <div class="summary-value" id="summary-rental-yield">0%</div>
                        <p>Direct rendement uit verhuur op jaarbasis.</p>
                    </div>

                    <div class="summary-card">
                        <h4>Verwachte Waardestijging</h4>
                        <div class="summary-value" id="summary-appreciation">0%</div>
                        <p>Prognose o.b.v. historisch en regionaal model (bron: MONSTAT).</p>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h4>Prijsontwikkeling Nieuwbouw Montenegro (€/m²)</h4>
                    <p>Gebaseerd op officieel onderzoek van MONSTAT (2019-2024) toont deze grafiek de gemiddelde prijsontwikkeling per vierkante meter voor nieuwbouwwoningen.</p>
                    <div class="chart-container">
                        <canvas id="cumulative-appreciation-chart"></canvas>
                    </div>
                </div>

            </div>

            <div class="result-panel" id="financial-panel">
                <div class="panel-section">
                    <h4>Investeringsopbouw (Montenegro)</h4>
                    <p>De totale bijkomende kosten in Montenegro. In de tabel hieronder vindt u een gedetailleerde vergelijking met andere landen.</p>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="investment-breakdown-chart"></canvas>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h4>Vergelijking Eenmalige Aankoopkosten</h4>
                    <p>Een overzicht van de geschatte bijkomende kosten ('Kosten Koper') voor uw ingevoerde aankoopprijs, vergeleken per land. De waarden zijn gebaseerd op de door u verstrekte data voor buitenlandse kopers.</p>
                    <table class="data-table" id="onetime-costs-comparison-table"></table>
                </div>
                <div class="panel-section">
                    <h4>Jaarlijkse Operationele Kosten (Montenegro)</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="annual-costs-chart"></canvas>
                    </div>
                    <table class="data-table" id="costs-table"></table>
                </div>
                <div class="considerations-list" style="border-left-color: var(--primary-turquoise);">
                    <h4>Toelichting op de Kosten</h4>
                    <ul>
                        <li>Deze cijfers dienen als een nauwkeurige indicatie, maar kunnen in de praktijk afwijken. Raadpleeg altijd een lokale specialist voor een definitieve kostenopgave.</li>
                    </ul>
                </div>
            </div>

            <div class="result-panel" id="rental-panel">
                <div id="rental-summary-section"></div>
                
                <div class="panel-section">
                    <h4>Verhuurinkomsten Prognose (Jaarlijks)</h4>
                    <table class="data-table" id="rental-income-table"></table>
                </div>
                
                <div class="panel-section">
                    <h4>Netto Verhuurresultaat</h4>
                    <table class="data-table" id="net-rental-result-table"></table>
                </div>
            </div>
            
            <div class="panel-section cta-section" id="lead-form-panel">
                <div class="cta-content">
                    <div class="cta-icon-container">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    </div>
                    <div class="cta-text">
                        <h2>Klaar voor de Volgende Stap?</h2>
                        <p>Heeft deze analyse uw interesse gewekt? Laat uw naam en e-mailadres achter. Een van onze specialisten neemt vrijblijvend contact met u op om uw vragen te beantwoorden en een persoonlijke toelichting te geven op uw investeringsmogelijkheden.</p>
                        <form id="contact-form" action="https://formspree.io/f/mjkrgqpr" method="POST">
                            <div class="cta-form-inputs">
                                <div class="form-group">
                                    <label for="userName">Naam</label>
                                    <input type="text" id="userName" name="name" class="form-control" required placeholder="Uw volledige naam">
                                </div>
                                <div class="form-group">
                                    <label for="userEmail">E-mailadres</label>
                                    <input type="email" id="userEmail" name="email" class="form-control" required placeholder="uw.email@voorbeeld.com">
                                </div>
                            </div>
                            <button type="submit" id="submit-form-btn" class="btn btn-primary btn-cta">Ja, neem contact met mij op</button>
                            <div id="form-status" style="text-align: center; margin-top: 1rem; font-weight: 600;"></div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="result-actions">
                <button class="btn btn-secondary" id="back-to-input">← Aanpassen</button>
                <a href="https://www.baysight.nl/contact/" target="_blank" class="btn btn-secondary">Direct contact opnemen</a>
            </div>
        </div>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay"></div>
    <div id="custom-modal" class="modal">
        <div class="modal-header">
            <h3>Financiële Waarschuwing</h3>
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modal-message"></p>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- STATE VARIABLES ---
    let currentStep = 0;
    let charts = {};
    let lastCalculation = {};

    // --- DOM ELEMENTEN ---
    const formSteps = document.querySelectorAll('.input-form');
    const progressSteps = document.querySelectorAll('.progress-step');
    const nextBtn = document.querySelector('.btn-next');
    const prevBtn = document.querySelector('.btn-prev');
    const calculateBtn = document.querySelector('.btn-calculate');
    const mainTabs = document.querySelectorAll('.tab');
    const calculatorSections = document.querySelectorAll('.calculator-section');
    const resultTabs = document.querySelectorAll('.result-tab');
    const resultPanels = document.querySelectorAll('.result-panel');
    const needFinancingToggle = document.getElementById('needFinancing');
    const financingDetails = document.querySelector('.financing-details');
    const usageTypeSelect = document.getElementById('usageType');
    const rentalDetails = document.querySelector('.rental-details');
    const personalUsageWeeksSlider = document.getElementById('personalUsageWeeks');
    const contactForm = document.getElementById('contact-form');
    const purchasePriceInput = document.getElementById('purchasePrice');
    const modalOverlay = document.getElementById('custom-modal-overlay');
    const modal = document.getElementById('custom-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalMessage = document.getElementById('modal-message');
    
    // --- Event Listeners & Setup ---
    function setupListeners() {
        nextBtn.addEventListener('click', handleNextClick);
        prevBtn.addEventListener('click', handlePrevClick);
        
        calculateBtn.addEventListener('click', runCalculation);
        purchasePriceInput.addEventListener('input', () => {
            if (currentStep === 1) updateFormState();
        });

        if (contactForm) {
            contactForm.addEventListener('submit', handleFormSubmit);
        }

        mainTabs.forEach(tab => tab.addEventListener('click', () => switchMainTab(tab)));
        resultTabs.forEach(tab => tab.addEventListener('click', () => switchResultTab(tab)));
        
        document.getElementById('back-to-input').addEventListener('click', () => {
            switchMainTab(document.querySelector('.tab[data-tab="input"]'));
        });

        needFinancingToggle.addEventListener('change', () => {
            financingDetails.style.display = needFinancingToggle.checked ? 'block' : 'none';
            document.getElementById('yes-financing-label').classList.toggle('active', needFinancingToggle.checked);
            document.getElementById('yes-financing-label').classList.toggle('inactive', !needFinancingToggle.checked);
            document.getElementById('no-financing-label').classList.toggle('active', !needFinancingToggle.checked);
            document.getElementById('no-financing-label').classList.toggle('inactive', needFinancingToggle.checked);
        });
        
        usageTypeSelect.addEventListener('change', () => {
            const usage = usageTypeSelect.value;
            rentalDetails.style.display = (usage === 'Combinatie' || usage === 'LangeTermijnVerhuur' || usage === 'KorteTermijnVerhuur') ? 'block' : 'none';
            if (usage !== 'Combinatie') {
                personalUsageWeeksSlider.value = 0;
                personalUsageWeeksSlider.dispatchEvent(new Event('input'));
            }
        });
        
        modalCloseBtn.addEventListener('click', hideModal);
        modalOverlay.addEventListener('click', hideModal);
        
        setupRangeSlider('personalUsageWeeks', 'personalUsageWeeksValue');
    }

    async function handleFormSubmit(event) {
        event.preventDefault(); 
        const statusDiv = document.getElementById('form-status');
        const submitBtn = document.getElementById('submit-form-btn');
        const userName = document.getElementById('userName').value;
        const userEmail = document.getElementById('userEmail').value;

        if (!userName || !userEmail) {
            statusDiv.textContent = 'Vul alstublieft uw naam en e-mailadres in.';
            statusDiv.style.color = 'var(--error)';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Bezig met versturen...';
        statusDiv.textContent = '';

        try {
            const response = await fetch(contactForm.action, {
                method: contactForm.method,
                body: new FormData(contactForm),
                headers: { 'Accept': 'application/json' }
            });

            if (response.ok) {
                statusDiv.textContent = 'Bedankt voor uw aanvraag! Wij nemen spoedig contact met u op.';
                statusDiv.style.color = 'var(--success)';
                contactForm.reset();
            } else {
                const data = await response.json();
                statusDiv.textContent = data.errors ? data.errors.map(e => e.message).join(", ") : 'Er is een fout opgetreden.';
                statusDiv.style.color = 'var(--error)';
            }
        } catch (error) {
            statusDiv.textContent = 'Netwerkfout. Controleer uw verbinding en probeer opnieuw.';
            statusDiv.style.color = 'var(--error)';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Ja, neem contact met mij op';
        }
    }

    // --- Navigatie & Validatie ---
    function handlePrevClick() {
        if (currentStep > 0) {
            currentStep--;
            updateFormState();
        }
    }

    function handleNextClick() {
        const totalForms = document.querySelectorAll('.input-form').length - 1;

        if (currentStep === 2) {
            if (!validateFinancials()) {
                return; 
            }
        }

        if (currentStep < totalForms) {
            currentStep++;
            updateFormState();
        }
    }
    
    function validateFinancials() {
        const inputs = gatherInputs();
        if (inputs.purchasePrice <= 0) return true;

        if (inputs.ownCapital < inputs.purchasePrice && !inputs.needFinancing) {
            const pPriceStr = (inputs.purchasePrice || 0).toLocaleString('nl-NL');
            const ownCapStr = (inputs.ownCapital || 0).toLocaleString('nl-NL');
            const message = `Uw eigen vermogen (€ ${ownCapStr}) is niet toereikend om de aankoopprijs van de woning (€ ${pPriceStr}) te dekken.<br><br>Verhoog uw eigen vermogen of selecteer 'Ja' bij 'Heeft u financiering nodig?' om door te gaan.`;
            showModal(message);
            return false;
        }
        return true;
    }

    // --- UI State & Updates ---
    function updateFormState() {
        const isStartScreen = currentStep === 0;
        document.querySelector('.progress-indicator').style.display = isStartScreen ? 'none' : 'flex';
        
        progressSteps.forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.toggle('active', stepNum === currentStep);
            step.classList.toggle('completed', stepNum < currentStep);
        });

        formSteps.forEach(form => form.classList.remove('active'));
        document.getElementById(`step-${currentStep}`).classList.add('active');
        prevBtn.disabled = isStartScreen;
        
        const totalForms = document.querySelectorAll('.input-form').length - 1;
        nextBtn.style.display = currentStep === totalForms ? 'none' : 'inline-block';
        calculateBtn.style.display = currentStep === totalForms ? 'inline-block' : 'none';
        
        nextBtn.disabled = (currentStep === 1 && (parseFloat(purchasePriceInput.value) || 0) <= 0);
    }
    
    function showModal(message) {
        modalMessage.innerHTML = message;
        modalOverlay.classList.add('visible');
        modal.classList.add('visible');
    }

    function hideModal() {
        modalOverlay.classList.remove('visible');
        modal.classList.remove('visible');
    }

    function switchMainTab(tab) {
        if (tab.classList.contains('disabled')) return;
        mainTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        calculatorSections.forEach(s => s.classList.remove('active'));
        document.getElementById(`${tab.dataset.tab}-section`).classList.add('active');
        if (tab.dataset.tab === 'input') {
            currentStep = 0;
            updateFormState();
        }
    }
    
    function switchResultTab(tab) {
        resultTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        resultPanels.forEach(p => p.classList.remove('active'));
        const activePanel = document.getElementById(`${tab.dataset.result}-panel`);
        if (activePanel) {
            activePanel.classList.add('active');
            drawChartsForPanel(tab.dataset.result);
        }
    }
    
    function setupRangeSlider(sliderId, displayId) {
        const slider = document.getElementById(sliderId);
        const display = document.getElementById(displayId);
        if(!slider || !display) return;
        const update = () => { display.textContent = slider.value; };
        slider.addEventListener('input', update);
        update();
    }

    // --- Core Calculation Logic ---
    function runCalculation() {
        const inputs = gatherInputs();
        
        // Calculate regional appreciation
        let baseAppreciation = 0.204; // YoY 2023-2024 from MONSTAT
        let appreciationMultiplier = 1.0;
        const coastalRegions = ['Kotor', 'Budva', 'Tivat', 'Bar'];
        if (coastalRegions.includes(inputs.region)) {
            appreciationMultiplier = 1.10; // +10% premium for coastal
        } else if (inputs.region === 'Noord') {
            appreciationMultiplier = 1 - 0.292; // -29.2% for northern
        }
        const finalAppreciation = baseAppreciation * appreciationMultiplier;

        const results = calculateAll(inputs);
        lastCalculation = { inputs, results, finalAppreciation }; 
        
        displayResults(inputs, results, finalAppreciation);
        
        const resultsTab = document.querySelector('.tab[data-tab="results"]');
        resultsTab.classList.remove('disabled');
        switchMainTab(resultsTab);
    }
    
    function gatherInputs() {
        return {
            purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
            furnishingCosts: parseFloat(document.getElementById('furnishingCosts').value) || 0,
            isNewBuild: document.getElementById('propertyCondition').value === 'new',
            propertyType: document.getElementById('propertyType').value,
            region: document.getElementById('region').value,
            propertySize: parseFloat(document.getElementById('propertySize').value) || 0,
            ownCapital: parseFloat(document.getElementById('ownCapital').value) || 0,
            needFinancing: document.getElementById('needFinancing').checked,
            financingInterestRate: parseFloat(document.getElementById('financingInterestRate').value) / 100 || 0,
            financingTerm: parseInt(document.getElementById('financingTerm').value) || 0,
            usageType: document.getElementById('usageType').value,
            personalUsageWeeks: parseInt(document.getElementById('personalUsageWeeks').value) || 0,
            managementPreference: document.getElementById('managementPreference').value,
        };
    }
    
    function calculateAll(inputs) {
        return {
            montenegro: calculateCountry(inputs, 'Montenegro'),
            spanje: calculateCountry(inputs, 'Spanje'),
            portugal: calculateCountry(inputs, 'Portugal'),
            italië: calculateCountry(inputs, 'Italië')
        };
    }
    
    function calculateCountry(inputs, country) {
        const { purchasePrice, isNewBuild, region, furnishingCosts, managementPreference, usageType, personalUsageWeeks, needFinancing, financingInterestRate, financingTerm, ownCapital, propertySize } = inputs;
        const results = { purchasePrice: purchasePrice || 0 };
        let params = {};
        let costBreakdown = {};

        costBreakdown.baySightCosts = Math.max(3000, purchasePrice * 0.015);

        switch(country) {
            case 'Montenegro':
                params = { managementFeeRate: { "Volledig uitbesteden": 0.10, "Gedeeltelijk uitbesteden": 0.08, "Zelf actief beheren": 0 }[managementPreference], effectiveTaxRate: 0.15 };
                if (!isNewBuild) {
                    if (purchasePrice <= 150000) { costBreakdown.tax = purchasePrice * 0.03; } 
                    else if (purchasePrice <= 500000) { costBreakdown.tax = 4500 + (purchasePrice - 150000) * 0.05; } 
                    else { costBreakdown.tax = 22000 + (purchasePrice - 500000) * 0.06; }
                } else { costBreakdown.tax = 0; }
                costBreakdown.notaryAndRegistrationCosts = Math.max(500, purchasePrice * 0.0025);
                costBreakdown.legalCosts = 500;
                costBreakdown.translatorCosts = 200;
                break;

            case 'Spanje':
                params = { managementFeeRate: 0.10, effectiveTaxRate: 0.19 };
                costBreakdown.tax = isNewBuild ? purchasePrice * 0.115 : purchasePrice * 0.07;
                costBreakdown.notaryAndRegistrationCosts = purchasePrice * 0.008;
                costBreakdown.legalCosts = purchasePrice * 0.0125;
                costBreakdown.otherCosts = 200;
                break;

            case 'Portugal':
                params = { managementFeeRate: 0.08, effectiveTaxRate: 0.28 };
                let imt = 0;
                if (purchasePrice <= 104261) { imt = purchasePrice * 0.01; } 
                else if (purchasePrice <= 142618) { imt = (purchasePrice * 0.02) - 1042.61; } 
                else if (purchasePrice <= 194458) { imt = (purchasePrice * 0.05) - 5321.15; } 
                else if (purchasePrice <= 324058) { imt = (purchasePrice * 0.07) - 9210.31; } 
                else if (purchasePrice <= 621501) { imt = (purchasePrice * 0.08) - 12450.89; } 
                else if (purchasePrice <= 1128287) { imt = purchasePrice * 0.06; } 
                else { imt = purchasePrice * 0.075; }
                costBreakdown.tax = imt;
                costBreakdown.stampDuty = purchasePrice * 0.008;
                costBreakdown.notaryAndRegistrationCosts = 1500;
                costBreakdown.legalCosts = purchasePrice * 0.0125;
                break;

            case 'Italië':
                params = { managementFeeRate: 0.10, taxOnGross: true, effectiveTaxRate: 0.21 }; 
                const estimatedCadastralValue = purchasePrice * 0.50;
                if (isNewBuild) { costBreakdown.tax = purchasePrice * 0.10; } 
                else { costBreakdown.tax = estimatedCadastralValue * 0.09; }
                const registrationFixedCosts = isNewBuild ? 400 : 100;
                costBreakdown.notaryAndRegistrationCosts = (purchasePrice * 0.015) + registrationFixedCosts;
                break;
        }
        results.costBreakdown = costBreakdown;
        
        const totalOneTimeCosts = Object.values(costBreakdown).reduce((sum, val) => sum + (val || 0), 0);
        results.totalInvestment = purchasePrice + totalOneTimeCosts + furnishingCosts;
        
        results.annualFinancingCost = 0;
        if(needFinancing) {
            const financingAmount = Math.max(0, results.totalInvestment - ownCapital);
            if (financingAmount > 0 && financingTerm > 0 && financingInterestRate > 0) {
                const r = financingInterestRate / 12;
                const n = financingTerm * 12;
                const monthlyPayment = (financingAmount * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                if (isFinite(monthlyPayment)) results.annualFinancingCost = monthlyPayment * 12;
            }
        }
        
        const regionYieldMultipliers = { 'Kotor': 1.05, 'Budva': 1.15, 'Tivat': 1.10, 'Bar': 0.95, 'Noord': 0.80 };
        const regionMultiplier = regionYieldMultipliers[region] || 1.0;
        
        let grossYieldRate = 0;
        if (usageType === 'LangeTermijnVerhuur') {
            const ltvYields = { 'Montenegro': 0.055, 'Spanje': 0.06, 'Portugal': 0.0525, 'Italië': 0.06 };
            grossYieldRate = country === 'Montenegro' ? ltvYields[country] * regionMultiplier : ltvYields[country];
        } else if (usageType === 'KorteTermijnVerhuur') {
            const ktvYields = { 'Montenegro': 0.085, 'Spanje': 0.07, 'Portugal': 0.065, 'Italië': 0.07 };
            grossYieldRate = country === 'Montenegro' ? ktvYields[country] * regionMultiplier : ktvYields[country];
        } else if (usageType === 'Combinatie') {
            const comboYields = { 'Montenegro': 0.07, 'Spanje': 0.065, 'Portugal': 0.0575, 'Italië': 0.065 };
            const baseAnnualYield = country === 'Montenegro' ? comboYields[country] * regionMultiplier : comboYields[country];
            const rentalWeeks = 52 - personalUsageWeeks;
            results.grossAnnualRentalIncome = (purchasePrice * baseAnnualYield / 52) * rentalWeeks;
        }

        if (usageType !== 'Combinatie') {
            results.grossAnnualRentalIncome = (usageType !== 'Vakantiewoning' && purchasePrice > 0) ? purchasePrice * grossYieldRate : 0;
        }

        results.rentalManagementFee = results.grossAnnualRentalIncome * (params.managementFeeRate || 0);
        results.netAnnualRentalIncome = results.grossAnnualRentalIncome - results.rentalManagementFee;
        
        switch(country) {
            case 'Montenegro':
                results.annualPropertyTax = purchasePrice * (0.6/100);
                results.annualInsurance = (propertySize || 0) * 1.35;
                results.annualMaintenance = 0;
                break;
            case 'Spanje':
                results.annualPropertyTax = (purchasePrice * 0.5) * 0.007; 
                results.annualInsurance = 225;
                results.annualMaintenance = 0;
                break;
            case 'Portugal':
                results.annualPropertyTax = (purchasePrice * 0.6) * 0.00375;
                results.annualInsurance = 300;
                results.annualMaintenance = 0;
                break;
            case 'Italië':
                results.annualPropertyTax = (purchasePrice * 0.5) * 0.0096;
                results.annualInsurance = 350;
                results.annualMaintenance = 0;
                break;
        }

        results.totalAnnualCostsBeforeFinancing = results.annualPropertyTax + results.annualInsurance + results.annualMaintenance;

        let taxAmount = 0;
        if (usageType !== 'Vakantiewoning' && results.grossAnnualRentalIncome > 0) {
            if (params.taxOnGross) {
                taxAmount = results.grossAnnualRentalIncome * params.effectiveTaxRate;
            } else {
                const netTaxableIncome = Math.max(0, results.netAnnualRentalIncome - results.totalAnnualCostsBeforeFinancing);
                taxAmount = netTaxableIncome * params.effectiveTaxRate;
            }
        }
        results.taxAmount = taxAmount;

        results.netAnnualCashflow = results.netAnnualRentalIncome - results.totalAnnualCostsBeforeFinancing - results.annualFinancingCost - results.taxAmount;
        results.netRentalYield = (results.totalInvestment > 0) ? (results.netAnnualCashflow / results.totalInvestment) : 0;
        
        return results;
    }

    // --- Result Display Functions ---
    function displayResults(inputs, allResults, finalAppreciation) {
        const { montenegro } = allResults;
        const formatCurrency = (value) => value || value === 0 ? new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' }).format(value) : '-';
        const formatPercent = (value, digits = 1) => value || value === 0 ? new Intl.NumberFormat('nl-NL', { style: 'percent', minimumFractionDigits: digits, maximumFractionDigits: digits }).format(value) : '-';

        document.getElementById('summary-property-type').textContent = inputs.propertyType;
        document.getElementById('summary-region').textContent = document.querySelector(`#region option[value="${inputs.region}"]`).textContent;
        document.getElementById('summary-total-investment').textContent = formatCurrency(montenegro.totalInvestment);
        document.getElementById('summary-annual-result').textContent = formatCurrency(montenegro.netAnnualCashflow);
        document.getElementById('summary-rental-yield').textContent = formatPercent(montenegro.netRentalYield, 2);
        document.getElementById('summary-appreciation').textContent = formatPercent(finalAppreciation, 1);

        displayOnetimeCostComparison(inputs, allResults, inputs.purchasePrice, formatCurrency, formatPercent);
        displayAnnualAndRoi(inputs, allResults, formatCurrency, formatPercent);
        
        drawChartsForPanel('summary', allResults);
        if (document.getElementById('financial-panel').classList.contains('active')) {
            drawChartsForPanel('financial', allResults);
        }
    }
    
    function displayOnetimeCostComparison(inputs, allResults, purchasePrice, formatCurrency, formatPercent) {
        const costKeys = [
            { key: 'tax', label: 'Overdrachtsbelasting / BTW', tooltip: 'Belasting op aankoop.' },
            { key: 'stampDuty', label: 'Zegelrecht', tooltip: 'Belasting op juridische documenten, van toepassing in Portugal (0.8%).' },
            { key: 'baySightCosts', label: 'Bay Sight Kosten', tooltip: '1.5% van de aanschafprijs met een minimum van €3.000.' },
            { key: 'legalCosts', label: 'Advocaatkosten', tooltip: 'Kosten voor juridische controle.' },
            { key: 'notaryAndRegistrationCosts', label: 'Notaris- en Registratiekosten', tooltip: 'Kosten voor de notaris en eigendomsregistratie.' },
            { key: 'translatorCosts', label: 'Tolk (verplicht)', tooltip: 'Verplichte kosten voor een beëdigd vertaler bij de notaris in Montenegro.' },
            { key: 'otherCosts', label: 'Overige kosten', tooltip: 'Extra kosten zoals een verplicht NIE-nummer in Spanje.' }
        ];

        let tableHTML = `<thead><tr><th>Kostenpost</th><th class="numeric-cell">Montenegro</th><th class="numeric-cell">Spanje</th><th class="numeric-cell">Portugal</th><th class="numeric-cell">Italië</th></tr></thead><tbody>`;
        const totals = { montenegro: 0, spanje: 0, portugal: 0, italië: 0 };
        const countryKeys = ['montenegro', 'spanje', 'portugal', 'italië'];
        
        costKeys.forEach(item => {
            if (item.key === 'tax' && inputs.isNewBuild) {
                return; 
            }

            const values = countryKeys.map(ck => allResults[ck].costBreakdown[item.key] || 0);
            if (values.some(v => v > 0)) {
                tableHTML += `<tr><td>${item.label}<span class="tooltip"><i class="tooltip-icon">i</i><span class="tooltip-text">${item.tooltip}</span></span></td>`;
                values.forEach((val, i) => {
                    tableHTML += `<td class="numeric-cell">${formatCurrency(val)}</td>`;
                    totals[countryKeys[i]] += val;
                });
                tableHTML += `</tr>`;
            }
        });

        tableHTML += `</tbody><tfoot><tr class="total-row"><td>Totaal bijkomende kosten</td>`;
        countryKeys.forEach(ck => tableHTML += `<td class="numeric-cell">${formatCurrency(totals[ck])}</td>`);
        tableHTML += `</tr><tr class="total-row"><td>Totaal als % van Koopsom</td>`;
        countryKeys.forEach(ck => tableHTML += `<td class="numeric-cell">${formatPercent(purchasePrice > 0 ? totals[ck] / purchasePrice : 0, 1)}</td>`);
        tableHTML += `</tr><tr class="total-row"><td><strong>Totale Aankoopsom (incl. kosten)</strong></td>`;
        countryKeys.forEach(ck => {
            const totalPurchasePrice = purchasePrice + totals[ck];
            tableHTML += `<td class="numeric-cell"><strong>${formatCurrency(totalPurchasePrice)}</strong></td>`;
        });
        tableHTML += `</tr></tfoot>`;
        
        document.getElementById('onetime-costs-comparison-table').innerHTML = tableHTML;
    }

    function displayAnnualAndRoi(inputs, allResults, formatCurrency, formatPercent) {
        const { montenegro } = allResults;
        const totalAnnualCosts = montenegro.totalAnnualCostsBeforeFinancing + montenegro.annualFinancingCost + montenegro.taxAmount;
        let costsTableBody = `
            <tr><td>Onroerendgoedbelasting<span class="tooltip"><i class="tooltip-icon">i</i><span class="tooltip-text">Jaarlijkse belasting op onroerend goed.</span></span></td><td class="numeric-cell">${formatCurrency(montenegro.annualPropertyTax)}</td></tr>
            <tr><td>Verzekering<span class="tooltip"><i class="tooltip-icon">i</i><span class="tooltip-text">Geschatte jaarlijkse premie voor een opstalverzekering.</span></span></td><td class="numeric-cell">${formatCurrency(montenegro.annualInsurance)}</td></tr>`;
        
        if (montenegro.annualMaintenance > 0) {
            costsTableBody += `<tr><td>Onderhoud<span class="tooltip"><i class="tooltip-icon">i</i><span class="tooltip-text">Jaarlijkse reservering voor onderhoudskosten.</span></span></td><td class="numeric-cell">${formatCurrency(montenegro.annualMaintenance)}</td></tr>`;
        }

        if (montenegro.annualFinancingCost > 0) {
            const interestRateFormatted = (inputs.financingInterestRate * 100).toLocaleString('nl-NL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            costsTableBody += `<tr><td>Financieringskosten (${interestRateFormatted}%)</td><td class="numeric-cell">${formatCurrency(montenegro.annualFinancingCost)}</td></tr>`;
        }
        if (montenegro.taxAmount > 0) {
            costsTableBody += `<tr><td>Belasting op Huurinkomsten</td><td class="numeric-cell">${formatCurrency(montenegro.taxAmount)}</td></tr>`;
        }
        costsTableBody += `<tr class="total-row"><td>Totale Jaarlijkse Kosten</td><td class="numeric-cell">${formatCurrency(totalAnnualCosts)}</td></tr>`;
        
        document.getElementById('costs-table').innerHTML = `<tbody>${costsTableBody}</tbody>`;
        
        const rentalSummarySection = document.getElementById('rental-summary-section');
        const rentalIncomeTableContainer = document.getElementById('rental-income-table').closest('.panel-section');
        const netRentalResultTableContainer = document.getElementById('net-rental-result-table').closest('.panel-section');

        if (inputs.usageType === 'Vakantiewoning') {
            rentalIncomeTableContainer.style.display = 'none';
            netRentalResultTableContainer.style.display = 'block';
            rentalSummarySection.style.display = 'none';
            const totalCostsOwnUse = montenegro.totalAnnualCostsBeforeFinancing + montenegro.annualFinancingCost;
            document.getElementById('net-rental-result-table').innerHTML = `<tbody><tr class="total-row"><td>Netto Jaarlijkse Kosten (eigen gebruik)</td><td class="numeric-cell">${formatCurrency(totalCostsOwnUse * -1)}</td></tr></tbody>`;
        } else {
            rentalIncomeTableContainer.style.display = 'block';
            netRentalResultTableContainer.style.display = 'block';
            rentalSummarySection.style.display = 'block';
            
            // Populate rental summary
            const rentalWeeks = 52 - inputs.personalUsageWeeks;
            let summaryHTML = `
                <div class="panel-section">
                    <div class="rental-summary-info">
                        <div>
                            <span class="info-label">Weken Eigen Gebruik</span>
                            <span class="info-value">${inputs.personalUsageWeeks}</span>
                        </div>
                        <div>
                            <span class="info-label">Weken Beschikbaar voor Verhuur</span>
                            <span class="info-value">${rentalWeeks}</span>
                        </div>
                    </div>
                    <table class="data-table">
                        <tbody>`;
            
            const grossYield = montenegro.totalInvestment > 0 ? (montenegro.grossAnnualRentalIncome / montenegro.totalInvestment) : 0;
            const netYield = montenegro.netRentalYield;

            summaryHTML += `
                <tr>
                    <td>Bruto Rendement <span class="tooltip"><i class="tooltip-icon">i</i><span class="tooltip-text">(Bruto Huur / Totale Investering). Rendement vóór aftrek van alle jaarlijkse kosten.</span></span></td>
                    <td class="numeric-cell">${formatPercent(grossYield, 2)}</td>
                </tr>
                <tr>
                    <td>Netto Huurrendement <span class="tooltip"><i class="tooltip-icon">i</i><span class="tooltip-text">(Netto Resultaat / Totale Investering). Rendement na aftrek van alle jaarlijkse kosten (incl. belasting en financiering).</span></span></td>
                    <td class="numeric-cell">${formatPercent(netYield, 2)}</td>
                </tr>
            </tbody></table></div>`;

            rentalSummarySection.innerHTML = summaryHTML;

            // Populate other tables
            document.getElementById('rental-income-table').innerHTML = `<tbody>
                <tr><td>Bruto Huurinkomsten</td><td class="numeric-cell">${formatCurrency(montenegro.grossAnnualRentalIncome)}</td></tr>
                <tr><td>Beheerkosten (${formatPercent(montenegro.managementFeeRate || 0, 0)})</td><td class="numeric-cell">-${formatCurrency(montenegro.rentalManagementFee)}</td></tr>
                <tr class="total-row"><td>Netto Huurinkomsten</td><td class="numeric-cell">${formatCurrency(montenegro.netAnnualRentalIncome)}</td></tr>
            </tbody>`;
            
            document.getElementById('net-rental-result-table').innerHTML = `<tbody>
                <tr><td>Netto Huurinkomsten</td><td class="numeric-cell">${formatCurrency(montenegro.netAnnualRentalIncome)}</td></tr>
                <tr><td style="padding-left: 2rem;">- Jaarlijkse Kosten (excl. financiering)</td><td class="numeric-cell">-${formatCurrency(montenegro.totalAnnualCostsBeforeFinancing + montenegro.taxAmount)}</td></tr>
                ${montenegro.annualFinancingCost > 0 ? `<tr><td style="padding-left: 2rem;">- Financieringskosten</td><td class="numeric-cell">-${formatCurrency(montenegro.annualFinancingCost)}</td></tr>` : ''}
                <tr class="total-row"><td>Netto Cashflow (Eindresultaat)</td><td class="numeric-cell">${formatCurrency(montenegro.netAnnualCashflow)}</td></tr>
            </tbody>`;
        }
    }
    
    // --- Charting Functions ---
    function destroyChart(chartId) {
        if (charts[chartId]) charts[chartId].destroy();
    }

    function drawChartsForPanel(panelId) {
        const { inputs, results } = lastCalculation;
        if (!inputs || !results) return;

        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.color = 'var(--text-secondary)';
        const sharedOptions = { responsive: true, maintainAspectRatio: false, animation: { duration: 800 } };

        if (panelId === 'summary') {
            destroyChart('country-comparison-chart');
            const comparisonCtx = document.getElementById('country-comparison-chart');
            if (comparisonCtx) {
                charts['country-comparison-chart'] = new Chart(comparisonCtx, { type: 'bar',
                    data: { labels: ['Montenegro', 'Spanje', 'Portugal', 'Italië'],
                        datasets: [{ label: 'Netto Huurrendement', data: [results.montenegro.netRentalYield * 100, results.spanje.netRentalYield * 100, results.portugal.netRentalYield * 100, results.italië.netRentalYield * 100], backgroundColor: ['#d4915f', '#F0B429', '#00A5CF', '#31C48D'] }] },
                    options: { ...sharedOptions, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: value => value.toFixed(1) + '%' } } } }
                });
            }

            destroyChart('cumulative-appreciation-chart');
            const appreciationCtx = document.getElementById('cumulative-appreciation-chart');
            if (appreciationCtx) {
                charts['cumulative-appreciation-chart'] = new Chart(appreciationCtx, { type: 'line',
                    data: { 
                        labels: ['2019', '2020', '2021', '2022', '2023', '2024'], 
                        datasets: [
                            { 
                                label: 'Gemiddelde Prijs (€/m²)', 
                                data: [1113, 951, 1194, 1339, 1532, 1844], 
                                borderColor: '#d4915f', 
                                tension: 0.1, 
                                pointBackgroundColor: '#d4915f' 
                            }
                        ]
                    }, 
                    options: { 
                        ...sharedOptions, 
                        plugins: { legend: { display: false } },
                        scales: { y: { title: { display: true, text: 'Prijs per m² (€)' } } } 
                    }
                });
            }
        }

        if (panelId === 'financial') {
            destroyChart('investment-breakdown-chart');
            const investmentCtx = document.getElementById('investment-breakdown-chart');
            if (investmentCtx) {
                const breakdown = results.montenegro.costBreakdown;
                const chartDataPoints = {
                    'Aankoopprijs': results.montenegro.purchasePrice,
                    'Belasting': breakdown.tax,
                    'Bay Sight Kosten': breakdown.baySightCosts,
                    'Advocaat': breakdown.legalCosts,
                    'Notaris- & Registratie': breakdown.notaryAndRegistrationCosts,
                    'Tolk': breakdown.translatorCosts,
                    'Inrichting': inputs.furnishingCosts,
                    'Zegelrecht': breakdown.stampDuty,
                    'Overige kosten': breakdown.otherCosts
                };
                const chartLabels = Object.keys(chartDataPoints).filter(key => chartDataPoints[key] > 0);
                const chartData = Object.values(chartDataPoints).filter(value => value > 0);
                charts['investment-breakdown-chart'] = new Chart(investmentCtx, { type: 'doughnut',
                    data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: ['#042943', '#d4915f', '#627D98', '#00A5CF', '#E12D39', '#F0B429', '#31C48D', '#9BB0C1', '#C6D8E5'], borderWidth: 0 }] },
                    options: { ...sharedOptions, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
                });
            }
            
            destroyChart('annual-costs-chart');
            const costsCtx = document.getElementById('annual-costs-chart');
            if (costsCtx) {
                const { montenegro } = results;
                const costPoints = { 'Vastgoedbelasting': montenegro.annualPropertyTax, 'Verzekering': montenegro.annualInsurance };
                if (montenegro.annualMaintenance > 0) costPoints['Onderhoud'] = montenegro.annualMaintenance;
                if (montenegro.annualFinancingCost > 0) costPoints['Financiering'] = montenegro.annualFinancingCost;
                if (montenegro.taxAmount > 0) costPoints['Huur-belasting'] = montenegro.taxAmount;

                const costsLabels = Object.keys(costPoints).filter(key => costPoints[key] > 0);
                const costsData = Object.values(costPoints).filter(value => value > 0);
                charts['annual-costs-chart'] = new Chart(costsCtx, { type: 'doughnut',
                    data: { labels: costsLabels, datasets: [{ data: costsData, backgroundColor: ['#042943', '#d4915f', '#00A5CF', '#627D98', '#F0B429'], borderWidth: 0 }] },
                    options: { ...sharedOptions, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
                });
            }
        }
    }
    
    // --- Initializer ---
    setupListeners();
    updateFormState();
});
</script>
</body>
</html>
