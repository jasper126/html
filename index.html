import React, { useMemo, useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  LineChart,
  Line,
  Area,
  AreaChart
} from "recharts";
import { cn } from "@/lib/utils";

// Color palette (Bay Sight)
const COLORS = {
  primaryBlue: "#042943",
  primaryOrange: "#d4915f",
  primaryTurquoise: "#00A5CF",
  secondaryLight: "#F0F4F8",
  secondaryMedium: "#D9E2EC",
  secondaryDark: "#627D98",
  success: "#31C48D",
  warning: "#F0B429",
  error: "#E12D39",
  textPrimary: "#102A43",
  textSecondary: "#486581",
  bg: "#FFFFFF",
  bgAlt: "#F8FAFC",
};

// ====== CONSTANTS (preserve original calculations) ======
const TRANSFER_TAX_RATE = 0.03; // 3%
const NOTARY_RATE = 0.005; // 0.5%
const REGISTRATION_RATE = 0.003; // 0.3%
const AGENT_RATE = 0.03; // 3%
const LAWYER_FEE = 1500; // €1.500

const PROPERTY_TAX_RATE = 0.001; // 0.1%
const RENTAL_TAX_RATE = 0.09; // 9%

const HIGH_SEASON_WEEKS = 12;
const LOW_SEASON_WEEKS = 34;
const HIGH_SEASON_OCCUPANCY = 0.85;
const LOW_SEASON_OCCUPANCY = 0.25;

const MANAGEMENT_RATE = 0.2; // 20%
const CLEANING_COST_PER_WEEK = 85;
const MARKETING_COST = 500;

const MONTENEGRO_APPRECIATION = 0.06; // 6%

// ====== Helpers ======
const fmtCurr = (v: number) =>
  "€" + (isFinite(v) ? Math.round(v).toLocaleString("nl-NL") : "-");
const fmtPct = (v: number) =>
  (isFinite(v) ? v.toLocaleString("nl-NL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "-") + "%";

// Types
type Inputs = {
  region: string;
  propertyType: string;
  propertySize: number | undefined;
  landSize: number | undefined;
  purchasePrice: number;
  condition: string;
  ownCapital: number;
  needFinancing: boolean;
  financingAmount?: number | undefined;
  financingType?: string;
  financingTerm?: number;
  investmentHorizon: number;
  usageType: string;
  rentalPeriod?: string;
  personalUsageWeeks: number;
  returnImportance: number;
  enjoymentImportance: number;
  managementPreference: string;
};

function useCalculations(i: Inputs) {
  return useMemo(() => {
    const purchasePrice = i.purchasePrice;

    // Initial costs
    const transferTax = purchasePrice * TRANSFER_TAX_RATE;
    const notaryCosts = purchasePrice * NOTARY_RATE;
    const registrationCosts = purchasePrice * REGISTRATION_RATE;
    const agentCosts = purchasePrice * AGENT_RATE;
    const lawyerCosts = LAWYER_FEE;
    const totalInvestment =
      purchasePrice + transferTax + notaryCosts + registrationCosts + agentCosts + lawyerCosts;

    // Annual costs
    const propertyTax = purchasePrice * PROPERTY_TAX_RATE;
    const insurance = purchasePrice * 0.004; // 0.4%
    const utilities = 750;
    const maintenance = purchasePrice * 0.0075; // 0.75%
    const totalAnnualCosts = propertyTax + insurance + utilities + maintenance;

    // Rental income (depends on price)
    const highSeasonWeeklyRate = (purchasePrice / 1000) * 5.33; // €5.33 per €1000 per week
    const lowSeasonWeeklyRate = highSeasonWeeklyRate * 0.44;

    // Adjust personal use: subtract personal weeks proportionally from seasons
    const totalWeeks = 52;
    const ownUse = Math.min(Math.max(i.personalUsageWeeks, 0), 52);
    const reduceFactor = (totalWeeks - ownUse) / totalWeeks; // scale occupancy weeks down

    const availableHighSeasonWeeks = HIGH_SEASON_WEEKS * reduceFactor;
    const availableLowSeasonWeeks = LOW_SEASON_WEEKS * reduceFactor;

    const highSeasonIncome = availableHighSeasonWeeks * highSeasonWeeklyRate * HIGH_SEASON_OCCUPANCY;
    const lowSeasonIncome = availableLowSeasonWeeks * lowSeasonWeeklyRate * LOW_SEASON_OCCUPANCY;
    const totalRentalIncome = highSeasonIncome + lowSeasonIncome;

    // Rental costs
    const managementCosts = totalRentalIncome * MANAGEMENT_RATE;
    const occupiedWeeks =
      availableHighSeasonWeeks * HIGH_SEASON_OCCUPANCY + availableLowSeasonWeeks * LOW_SEASON_OCCUPANCY;
    const cleaningCosts = occupiedWeeks * CLEANING_COST_PER_WEEK;
    const marketingCosts = MARKETING_COST;

    const netRentalIncome = totalRentalIncome - managementCosts - cleaningCosts - marketingCosts;
    const rentalTax = netRentalIncome * RENTAL_TAX_RATE;
    const netAfterTax = netRentalIncome - rentalTax;

    // Annual result
    const annualResult = netAfterTax - totalAnnualCosts;

    // Yields
    const cashYield = (annualResult / totalInvestment) * 100;
    const appreciationYield = MONTENEGRO_APPRECIATION * 100;
    const totalYield = cashYield + appreciationYield;

    // Value projection
    const horizon = Math.max(i.investmentHorizon, 1);
    const futureValue = purchasePrice * Math.pow(1 + MONTENEGRO_APPRECIATION, horizon);
    const totalAppreciation = futureValue - purchasePrice;

    // Break-even
    const cashBreakEven = annualResult > 0 ? totalInvestment / annualResult : Infinity;
    const totalBreakEven = Math.log(totalInvestment / purchasePrice + 1) / Math.log(1 + MONTENEGRO_APPRECIATION);

    return {
      // inputs mirrored
      region: i.region,
      propertyType: i.propertyType,
      personalUseWeeks: i.personalUsageWeeks,
      investmentHorizon: horizon,

      // costs & income
      purchasePrice,
      transferTax,
      notaryCosts,
      registrationCosts,
      agentCosts,
      lawyerCosts,
      totalInvestment,
      propertyTax,
      insurance,
      utilities,
      maintenance,
      totalAnnualCosts,
      highSeasonWeeklyRate,
      lowSeasonWeeklyRate,
      highSeasonIncome,
      lowSeasonIncome,
      totalRentalIncome,
      managementCosts,
      cleaningCosts,
      marketingCosts,
      netRentalIncome,
      rentalTax,
      netAfterTax,
      annualResult,
      cashYield,
      appreciationYield,
      totalYield,
      futureValue,
      totalAppreciation,
      cashBreakEven,
      totalBreakEven,
    };
  }, [i]);
}

const SectionTitle = ({ title, subtitle }: { title: string; subtitle?: string }) => (
  <div className="mb-4">
    <h3 className="text-xl font-semibold text-[--tw-text-primary]">{title}</h3>
    {subtitle && <p className="text-sm text-muted-foreground">{subtitle}</p>}
  </div>
);

const StatCard = ({ label, value, sub }: { label: string; value: string; sub?: string }) => (
  <Card className="rounded-2xl shadow-sm border-neutral-200">
    <CardContent className="p-5">
      <p className="text-sm text-muted-foreground mb-1">{label}</p>
      <p className="text-2xl font-semibold">{value}</p>
      {sub && <p className="text-xs text-muted-foreground mt-2">{sub}</p>}
    </CardContent>
  </Card>
);

function Header() {
  return (
    <div className="bg-[" + COLORS.primaryBlue + "] text-white rounded-2xl p-6 shadow-sm">
      <div className="flex items-center justify-between gap-4 flex-wrap">
        <h2 className="text-2xl font-bold tracking-tight">
          <span className="text-[" + COLORS.primaryOrange + "]">BAY SIGHT</span> Woning Calculator Montenegro
        </h2>
        <div className="flex items-center gap-2">
          <Button variant="secondary" className="rounded-xl" onClick={() => window.print()}>Opslaan als PDF</Button>
          <Button className="bg-[" + COLORS.primaryOrange + "] hover:opacity-90 rounded-xl" onClick={() => window.scrollTo({ top: 0, behavior: "smooth" })}>
            Opnieuw
          </Button>
        </div>
      </div>
    </div>
  );
}

function InputGrid({ inputs, setInputs }: { inputs: Inputs; setInputs: (i: Inputs) => void }) {
  const set = (patch: Partial<Inputs>) => setInputs({ ...inputs, ...patch });

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-3">
          <SectionTitle title="1. Woning" />
          <div className="space-y-2">
            <Label>Regio</Label>
            <Select value={inputs.region} onValueChange={(v) => set({ region: v })}>
              <SelectTrigger className="rounded-xl"><SelectValue placeholder="Selecteer een regio" /></SelectTrigger>
              <SelectContent>
                {['Kotor','Budva','Tivat','Bar'].map(r => (
                  <SelectItem key={r} value={r}>{r}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="space-y-2">
            <Label>Type woning</Label>
            <Select value={inputs.propertyType} onValueChange={(v) => set({ propertyType: v })}>
              <SelectTrigger className="rounded-xl"><SelectValue placeholder="Selecteer een type" /></SelectTrigger>
              <SelectContent>
                {['Appartement','Villa','Townhouse','Landhuis'].map(t => (
                  <SelectItem key={t} value={t}>{t}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <Label>Woonoppervlakte (m²)</Label>
              <Input type="number" className="rounded-xl" value={inputs.propertySize ?? ''} onChange={(e) => set({ propertySize: Number(e.target.value) })} />
            </div>
            <div>
              <Label>Perceel (m²)</Label>
              <Input type="number" className="rounded-xl" value={inputs.landSize ?? ''} onChange={(e) => set({ landSize: Number(e.target.value) })} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <Label>Aankoopprijs (€)</Label>
              <Input type="number" className="rounded-xl" value={inputs.purchasePrice} onChange={(e) => set({ purchasePrice: Number(e.target.value) })} />
            </div>
            <div>
              <Label>Staat van onderhoud</Label>
              <Select value={inputs.condition} onValueChange={(v) => set({ condition: v })}>
                <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                <SelectContent>
                  {['Nieuwbouw','Uitstekend','Goed','Redelijk','Renovatie nodig'].map(c => (
                    <SelectItem key={c} value={c}>{c}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-3">
          <SectionTitle title="2. Financieel" />
          <div>
            <Label>Eigen vermogen (€)</Label>
            <Input type="number" className="rounded-xl" value={inputs.ownCapital} onChange={(e) => set({ ownCapital: Number(e.target.value) })} />
          </div>
          <div className="flex items-center justify-between py-2">
            <Label className="mr-2">Financiering nodig?</Label>
            <Switch checked={inputs.needFinancing} onCheckedChange={(v) => set({ needFinancing: v })} />
          </div>
          {inputs.needFinancing && (
            <div className="grid grid-cols-3 gap-3">
              <div>
                <Label>Bedrag (€)</Label>
                <Input type="number" className="rounded-xl" value={inputs.financingAmount ?? 0} onChange={(e) => set({ financingAmount: Number(e.target.value) })} />
              </div>
              <div>
                <Label>Looptijd (jaren)</Label>
                <Input type="number" className="rounded-xl" value={inputs.financingTerm ?? 15} onChange={(e) => set({ financingTerm: Number(e.target.value) })} />
              </div>
              <div>
                <Label>Type</Label>
                <Select value={inputs.financingType ?? "Hypotheek in Nederland"} onValueChange={(v) => set({ financingType: v })}>
                  <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                  <SelectContent>
                    {['Hypotheek in Nederland','Lokale hypotheek','Anders'].map(f => (
                      <SelectItem key={f} value={f}>{f}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          )}
          <div>
            <Label>Investeringshorizon (jaren)</Label>
            <input type="range" min={1} max={30} value={inputs.investmentHorizon}
              onChange={(e) => set({ investmentHorizon: Number(e.target.value) })} className="w-full" />
            <div className="text-right text-sm text-muted-foreground">{inputs.investmentHorizon} jaar</div>
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-3">
          <SectionTitle title="3. Gebruik" />
          <div>
            <Label>Primair gebruik</Label>
            <Select value={inputs.usageType} onValueChange={(v) => set({ usageType: v })}>
              <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
              <SelectContent>
                {['Vakantiewoning','Permanente bewoning','Verhuur','Combinatie'].map(u => (
                  <SelectItem key={u} value={u}>{u}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          {(inputs.usageType === 'Verhuur' || inputs.usageType === 'Combinatie') && (
            <>
              <div>
                <Label>Type verhuur</Label>
                <Select value={inputs.rentalPeriod ?? 'Korte termijn (vakantieverhuur)'} onValueChange={(v) => set({ rentalPeriod: v })}>
                  <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                  <SelectContent>
                    {['Korte termijn (vakantieverhuur)','Lange termijn (vaste huurder)','Beide'].map(r => (
                      <SelectItem key={r} value={r}>{r}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Eigen gebruik (weken/jaar)</Label>
                <input type="range" min={0} max={52} value={inputs.personalUsageWeeks}
                  onChange={(e) => set({ personalUsageWeeks: Number(e.target.value) })} className="w-full" />
                <div className="text-right text-sm text-muted-foreground">{inputs.personalUsageWeeks} weken</div>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-3">
          <SectionTitle title="4. Voorkeuren" />
          <div>
            <Label>Belang van rendement</Label>
            <input type="range" min={1} max={10} value={inputs.returnImportance}
              onChange={(e) => set({ returnImportance: Number(e.target.value) })} className="w-full" />
            <div className="text-right text-sm text-muted-foreground">{inputs.returnImportance}/10</div>
          </div>
          <div>
            <Label>Belang van gebruiksgenot</Label>
            <input type="range" min={1} max={10} value={inputs.enjoymentImportance}
              onChange={(e) => set({ enjoymentImportance: Number(e.target.value) })} className="w-full" />
            <div className="text-right text-sm text-muted-foreground">{inputs.enjoymentImportance}/10</div>
          </div>
          <div>
            <Label>Beheer voorkeur</Label>
            <Select value={inputs.managementPreference} onValueChange={(v) => set({ managementPreference: v })}>
              <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
              <SelectContent>
                {['Zelf actief beheren','Gedeeltelijk uitbesteden','Volledig uitbesteden'].map(m => (
                  <SelectItem key={m} value={m}>{m}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function Summary({ calc }: { calc: ReturnType<typeof useCalculations> }) {
  const investData = [
    { name: "Aankoopprijs", value: calc.purchasePrice, color: COLORS.primaryBlue },
    { name: "Aankoopkosten", value: calc.totalInvestment - calc.purchasePrice, color: COLORS.primaryOrange },
  ];

  const annualBars = [
    { name: "Inkomsten", waarde: Math.max(calc.totalRentalIncome, 0) },
    { name: "Kosten", waarde: Math.max(calc.totalAnnualCosts + calc.managementCosts + calc.cleaningCosts + calc.marketingCosts + calc.rentalTax, 0) },
    { name: "Resultaat", waarde: calc.annualResult },
  ];

  const valueSeries = Array.from({ length: calc.investmentHorizon + 1 }, (_, t) => ({
    jaar: t,
    waarde: calc.purchasePrice * Math.pow(1 + MONTENEGRO_APPRECIATION, t),
    cashflowCum: -calc.totalInvestment + calc.annualResult * t,
    totalCum: -calc.totalInvestment + calc.annualResult * t + (calc.purchasePrice * Math.pow(1 + MONTENEGRO_APPRECIATION, t) - calc.purchasePrice),
  }));

  return (
    <div className="space-y-5">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <StatCard label="Totale investering" value={fmtCurr(calc.totalInvestment)} />
        <StatCard label="Jaarlijks resultaat" value={fmtCurr(calc.annualResult)} />
        <StatCard label="Totaal rendement" value={fmtPct(calc.totalYield)} />
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-4">
        <Card className="rounded-2xl">
          <CardContent className="p-5">
            <p className="text-sm text-muted-foreground mb-2">Investering breakdown</p>
            <div className="h-56">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={investData} dataKey="value" nameKey="name" innerRadius={60} outerRadius={90}>
                    {investData.map((d, idx) => (
                      <Cell key={idx} fill={d.color} />
                    ))}
                  </Pie>
                  <Tooltip formatter={(v:number) => fmtCurr(v)} />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>

        <Card className="rounded-2xl">
          <CardContent className="p-5">
            <p className="text-sm text-muted-foreground mb-2">Jaarlijks resultaat</p>
            <div className="h-56">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={annualBars}>
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip formatter={(v:number) => fmtCurr(v)} />
                  <Bar dataKey="waarde" fill={COLORS.primaryOrange} radius={[8,8,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>

        <Card className="rounded-2xl">
          <CardContent className="p-5">
            <p className="text-sm text-muted-foreground mb-2">Waardeontwikkeling & Break-even</p>
            <div className="h-56">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={valueSeries}>
                  <XAxis dataKey="jaar" />
                  <YAxis />
                  <Tooltip formatter={(v:number) => fmtCurr(v)} />
                  <Legend />
                  <Line type="monotone" dataKey="waarde" name="Waarde" stroke={COLORS.primaryOrange} strokeWidth={2} dot={false} />
                  <Line type="monotone" dataKey="cashflowCum" name="Cumulatieve cashflow" stroke={COLORS.error} strokeWidth={1.5} dot={false} />
                  <Line type="monotone" dataKey="totalCum" name="Cashflow + waardestijging" stroke={COLORS.success} strokeWidth={1.5} dot={false} />
                </LineChart>
              </ResponsiveContainer>
            </div>
            <p className="text-xs text-muted-foreground mt-2">
              Break-even cashflow: {isFinite(calc.cashBreakEven) ? calc.cashBreakEven.toFixed(1) + ' jaar' : 'n.v.t.'} ·
              Inclusief waardestijging: {calc.totalBreakEven.toFixed(1)} jaar
            </p>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

function Financials({ calc }: { calc: ReturnType<typeof useCalculations> }) {
  const initRows = [
    ["Aankoopprijs", fmtCurr(calc.purchasePrice), (calc.purchasePrice / calc.totalInvestment) * 100],
    ["Overdrachtsbelasting", fmtCurr(calc.transferTax), (calc.transferTax / calc.totalInvestment) * 100],
    ["Notariskosten", fmtCurr(calc.notaryCosts), (calc.notaryCosts / calc.totalInvestment) * 100],
    ["Registratiekosten", fmtCurr(calc.registrationCosts), (calc.registrationCosts / calc.totalInvestment) * 100],
    ["Makelaarskosten", fmtCurr(calc.agentCosts), (calc.agentCosts / calc.totalInvestment) * 100],
    ["Advocaatkosten", fmtCurr(calc.lawyerCosts), (calc.lawyerCosts / calc.totalInvestment) * 100],
  ];

  const annualRows = [
    ["Onroerendgoedbelasting", fmtCurr(calc.propertyTax), (calc.propertyTax / calc.totalAnnualCosts) * 100],
    ["Verzekeringen", fmtCurr(calc.insurance), (calc.insurance / calc.totalAnnualCosts) * 100],
    ["Nutsvoorzieningen", fmtCurr(calc.utilities), (calc.utilities / calc.totalAnnualCosts) * 100],
    ["Onderhoud", fmtCurr(calc.maintenance), (calc.maintenance / calc.totalAnnualCosts) * 100],
  ];

  const initPie = [
    { name: "Aankoopprijs", value: calc.purchasePrice, color: COLORS.primaryBlue },
    { name: "Overdrachtsbelasting", value: calc.transferTax, color: "#bb764f" },
    { name: "Notariskosten", value: calc.notaryCosts, color: "#c99273" },
    { name: "Registratiekosten", value: calc.registrationCosts, color: "#dcb399" },
    { name: "Makelaarskosten", value: calc.agentCosts, color: "#6a879d" },
    { name: "Advocaatkosten", value: calc.lawyerCosts, color: "#9fb0be" },
  ];

  const annualPie = [
    { name: "OG-belasting", value: calc.propertyTax, color: COLORS.primaryBlue },
    { name: "Verzekeringen", value: calc.insurance, color: "#6a879d" },
    { name: "Nuts", value: calc.utilities, color: COLORS.primaryOrange },
    { name: "Onderhoud", value: calc.maintenance, color: "#e3b695" },
  ];

  return (
    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-4">
          <SectionTitle title="Initiële investering" />
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={initPie} dataKey="value" nameKey="name" outerRadius={95}>
                  {initPie.map((d, i) => (
                    <Cell key={i} fill={d.color} />
                  ))}
                </Pie>
                <Tooltip formatter={(v:number) => fmtCurr(v)} />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b">
                  <th className="py-2">Kostenpost</th>
                  <th>Bedrag</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody>
                {initRows.map((r, idx) => (
                  <tr key={idx} className="border-b last:border-0">
                    <td className="py-2">{r[0]}</td>
                    <td>{r[1]}</td>
                    <td>{fmtPct(Number(r[2]))}</td>
                  </tr>
                ))}
                <tr>
                  <td className="py-2 font-semibold">Totaal</td>
                  <td className="font-semibold">{fmtCurr(calc.totalInvestment)}</td>
                  <td className="font-semibold">100,00%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-4">
          <SectionTitle title="Jaarlijkse kosten" />
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={annualPie} dataKey="value" nameKey="name" outerRadius={95}>
                  {annualPie.map((d, i) => (
                    <Cell key={i} fill={d.color} />
                  ))}
                </Pie>
                <Tooltip formatter={(v:number) => fmtCurr(v)} />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b">
                  <th className="py-2">Kostenpost</th>
                  <th>Bedrag</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody>
                {annualRows.map((r, idx) => (
                  <tr key={idx} className="border-b last:border-0">
                    <td className="py-2">{r[0]}</td>
                    <td>{r[1]}</td>
                    <td>{fmtPct(Number(r[2]))}</td>
                  </tr>
                ))}
                <tr>
                  <td className="py-2 font-semibold">Totaal</td>
                  <td className="font-semibold">{fmtCurr(calc.totalAnnualCosts)}</td>
                  <td className="font-semibold">100,00%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function Rental({ calc }: { calc: ReturnType<typeof useCalculations> }) {
  const incomeBars = [
    { name: "Hoogseizoen", waarde: calc.highSeasonIncome },
    { name: "Laagseizoen", waarde: calc.lowSeasonIncome },
  ];

  const resultBars = [
    { name: "Bruto inkomsten", waarde: calc.totalRentalIncome },
    { name: "Kosten", waarde: -(calc.managementCosts + calc.cleaningCosts + calc.marketingCosts) },
    { name: "Belasting", waarde: -calc.rentalTax },
    { name: "Netto resultaat", waarde: calc.netAfterTax },
  ];

  return (
    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-4">
          <SectionTitle title="Bruto verhuurinkomsten" />
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={incomeBars}>
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip formatter={(v:number) => fmtCurr(v)} />
                <Bar dataKey="waarde" fill={COLORS.primaryOrange} radius={[8,8,0,0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b">
                  <th className="py-2">Periode</th>
                  <th>Weekprijs</th>
                  <th>Bezetting</th>
                  <th>Inkomsten</th>
                </tr>
              </thead>
              <tbody>
                <tr className="border-b">
                  <td className="py-2">Hoogseizoen</td>
                  <td>{fmtCurr(calc.highSeasonWeeklyRate)}</td>
                  <td>85%</td>
                  <td>{fmtCurr(calc.highSeasonIncome)}</td>
                </tr>
                <tr>
                  <td className="py-2">Laagseizoen</td>
                  <td>{fmtCurr(calc.lowSeasonWeeklyRate)}</td>
                  <td>25%</td>
                  <td>{fmtCurr(calc.lowSeasonIncome)}</td>
                </tr>
                <tr>
                  <td className="py-2 font-semibold">Totaal</td>
                  <td>-</td>
                  <td>-</td>
                  <td className="font-semibold">{fmtCurr(calc.totalRentalIncome)}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl">
        <CardContent className="p-5 space-y-4">
          <SectionTitle title="Netto verhuurresultaat" />
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={resultBars}>
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip formatter={(v:number) => fmtCurr(v)} />
                <Bar dataKey="waarde" fill={COLORS.primaryBlue} radius={[8,8,0,0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b">
                  <th className="py-2">Post</th>
                  <th>Bedrag</th>
                </tr>
              </thead>
              <tbody>
                <tr className="border-b"><td className="py-2">Bruto verhuurinkomsten</td><td>{fmtCurr(calc.totalRentalIncome)}</td></tr>
                <tr className="border-b"><td>Beheerkosten (20%)</td><td>-{fmtCurr(calc.managementCosts)}</td></tr>
                <tr className="border-b"><td>Schoonmaakkosten</td><td>-{fmtCurr(calc.cleaningCosts)}</td></tr>
                <tr className="border-b"><td>Marketingkosten</td><td>-{fmtCurr(calc.marketingCosts)}</td></tr>
                <tr className="border-b"><td>Netto verhuurinkomsten</td><td>{fmtCurr(calc.netRentalIncome)}</td></tr>
                <tr className="border-b"><td>Lokale belasting (9%)</td><td>-{fmtCurr(calc.rentalTax)}</td></tr>
                <tr><td className="font-semibold">Netto na belasting</td><td className="font-semibold">{fmtCurr(calc.netAfterTax)}</td></tr>
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function ROI({ calc }: { calc: ReturnType<typeof useCalculations> }) {
  const roiCompare = [
    { name: "Spaarrekening", waarde: 1.0 },
    { name: "Obligaties", waarde: 3.0 },
    { name: "Verhuur NL", waarde: 4.0 },
    { name: "Vastgoedfonds", waarde: 5.0 },
    { name: "Italië", waarde: 5.15 },
    { name: "Spanje", waarde: 5.97 },
    { name: "Portugal", waarde: 6.35 },
    { name: "Aandelen", waarde: 7.0 },
    { name: "Montenegro", waarde: calc.totalYield },
  ];

  const stackedCountry = [
    { land: 'Montenegro', cash: calc.cashYield, app: calc.appreciationYield },
    { land: 'Portugal', cash: 1.85, app: 4.50 },
    { land: 'Spanje', cash: 1.97, app: 4.00 },
    { land: 'Italië', cash: 1.65, app: 3.50 },
  ];

  return (
    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
      <Card className="rounded-2xl">
        <CardContent className="p-5">
          <SectionTitle title="Rendementsvergelijking" />
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={roiCompare}>
                <XAxis dataKey="name" interval={0} angle={-20} textAnchor="end" height={60} />
                <YAxis />
                <Tooltip formatter={(v:number) => fmtPct(v)} />
                <Bar dataKey="waarde" fill={COLORS.primaryBlue} radius={[8,8,0,0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl">
        <CardContent className="p-5">
          <SectionTitle title="Landen (cash + waardestijging)" />
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={stackedCountry} stackOffset="expand">
                <XAxis dataKey="land" />
                <YAxis tickFormatter={(v) => fmtPct(v * 100)} />
                <Tooltip formatter={(v:number) => fmtPct(v)} />
                <Legend />
                <Bar dataKey="cash" stackId="a" fill={COLORS.primaryBlue} name="Cash rendement" />
                <Bar dataKey="app" stackId="a" fill={COLORS.primaryOrange} name="Waardestijging" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

export default function BaySightCalculator2025() {
  const [inputs, setInputs] = useState<Inputs>({
    region: "Kotor",
    propertyType: "Appartement",
    propertySize: undefined,
    landSize: undefined,
    purchasePrice: 150000,
    condition: "Goed",
    ownCapital: 150000,
    needFinancing: false,
    financingAmount: undefined,
    financingType: "Hypotheek in Nederland",
    financingTerm: 15,
    investmentHorizon: 15,
    usageType: "Vakantiewoning",
    rentalPeriod: "Korte termijn (vakantieverhuur)",
    personalUsageWeeks: 6,
    returnImportance: 7,
    enjoymentImportance: 8,
    managementPreference: "Gedeeltelijk uitbesteden",
  });

  const calc = useCalculations(inputs);

  return (
    <div className="mx-auto max-w-7xl p-4 md:p-6 space-y-6">
      <Header />

      <Tabs defaultValue="input" className="w-full">
        <TabsList className="rounded-2xl bg-white shadow-sm">
          <TabsTrigger value="input" className="rounded-xl">Gegevens invoeren</TabsTrigger>
          <TabsTrigger value="results" className="rounded-xl">Resultaten</TabsTrigger>
        </TabsList>

        <TabsContent value="input" className="space-y-4 mt-4">
          <InputGrid inputs={inputs} setInputs={setInputs} />
          <div className="flex justify-end">
            <Button className="bg-[" + COLORS.primaryOrange + "] hover:opacity-90 rounded-xl px-6 py-6 text-base" onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}>
              Bereken
            </Button>
          </div>
        </TabsContent>

        <TabsContent value="results" className="space-y-6 mt-4">
          <Summary calc={calc} />
          <Financials calc={calc} />
          <Rental calc={calc} />
          <ROI calc={calc} />

          <Card className="rounded-2xl">
            <CardContent className="p-5 space-y-2">
              <SectionTitle title="Belangrijkste aandachtspunten" />
              <ul className="list-disc pl-5 text-sm text-muted-foreground space-y-1">
                <li>Buitenlanders kunnen vrijelijk onroerend goed kopen in Montenegro</li>
                <li>Notaris is verplicht bij overdracht</li>
                <li>Lage belastingtarieven vergeleken met West‑Europa</li>
                <li>Geen vermogensbelasting</li>
                <li>Belastingverdrag met Nederland aanwezig, belasting wordt betaald in Montenegro</li>
              </ul>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
